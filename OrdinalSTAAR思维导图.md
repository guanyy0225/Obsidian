
## NullModel

`NullModel` 函数中最重要的计算部分，其**唯一目的**是预先计算分数检验 (Score Test) 方差公式中所有与基因型无关的、耗时的组件。通过在拟合零模型时仅计算一次这些组件，后续成千上万个基因的关联检验将变得极其快速。

#### 1. 核心背景：分数检验 (Score Test)

后续所有基因关联检验都基于分数检验，其统计量 `T` 的通用形式为：
`T = U² / Var(U)`

*   **得分 (Score, `U`)**: `U = G' * residuals`
    *   衡量基因型得分 `G` 与模型残差 `residuals` 之间的协方差。
*   **得分方差 (Variance of Score, `Var(U)`)**: 这是校正了协变量 `X` 影响后 `U` 的方差。

#### 2. `Var(U)` 的完整公式

`Var(U) = G'WG - (G'WX) * (X'WX)⁻¹ * (X'WG)`

*   **`G`**: 基因型得分向量。
*   **`W`**: **权重矩阵** (`W_mat`)，代表每个观测值的信息量。
*   **`X`**: **协变量矩阵** (`X_mat`)。

这个公式由两部分构成：
1.  `G'WG`: 基因型得分的 **原始（未校正）方差**。
2.  `(G'WX) * (X'WX)⁻¹ * (X'WG)`: 这是由协变量 `X` 所能解释掉的方差。从原始方差中**减去**这部分，就得到了最终校正后的方差。

`NullModel` 的任务就是预先计算出 `W`、`WX` 和 `(X'WX)⁻¹`。

---

### 预计算组件的维度详解

为了理解矩阵运算，我们定义：
*   `n`: 样本量 (即 `nrow(X_mat)`)
*   `p`: 协变量的数量，包括截距项 (即 `ncol(X_mat)`)

#### 1. `W_mat` (权重矩阵 `W`)
```R
W_mat <- Matrix::Diagonal(x = 1 / var_y)
```
*   **计算内容**: 根据每个样本的潜在方差 `var_y` 创建一个对角权重矩阵。
*   **输入 `1 / var_y` 维度**: 长度为 `n` 的向量。
*   **输出 `W_mat` 维度**: **`n x n`**
*   **结构**: 这是一个稀疏对角矩阵，仅在主对角线上有 `n` 个非零值，其余元素均为零。`Matrix` 包能高效存储和处理它。

#### 2. `X_t_W` (数学表达式 `X'W`)
```R
X_t_W <- crossprod(X_mat, W_mat)
```
*   **计算内容**: 计算 `X_mat` 的转置 (`X'`) 与 `W_mat` (`W`) 的乘积。
*   **运算过程**: `(X') * W`  =>  `(p x n) * (n x n)`
*   **输出 `X_t_W` 维度**: **`p x n`**

#### 3. `XWX_mat` (信息矩阵 `X'WX`)
```R
XWX_mat <- X_t_W %*% X_mat
```
*   **计算内容**: 使用上一步的结果 `X_t_W` (`X'W`) 乘以 `X_mat` (`X`)。
*   **运算过程**: `(X'W) * X` => `(p x n) * (n x p)`
*   **输出 `XWX_mat` 维度**: **`p x p`**
*   **解释**: 这是一个相对较小的方阵，其大小仅取决于协变量数量 `p`，与庞大的样本量 `n` 无关。这是效率的关键。

#### 4. `XWX_inv` (信息矩阵的逆 `(X'WX)⁻¹`)
```R
XWX_inv <- solve(XWX_mat)
```
*   **计算内容**: 对 `XWX_mat` 求逆。这是整个预计算流程中**最耗时**的一步。
*   **运算过程**: `solve(p x p matrix)`
*   **输出 `XWX_inv` 维度**: **`p x p`**
*   **解释**: 将矩阵求逆这一昂贵操作在 `NullModel` 中只执行一次，是 STAAR 方法高效性的根本保障。

#### 5. `WX_mat` (数学表达式 `WX`)
```R
WX_mat <- t(X_t_W)
```
*   **计算内容**: 对 `X_t_W` (`X'W`) 进行转置。根据矩阵性质 `(X'W)' = W'X'' = WX`。
*   **运算过程**: `t(p x n matrix)`
*   **输出 `WX_mat` 维度**: **`n x p`**
*   **解释**: 预先计算并存储 `WX`，使得在后续上千次检验中计算 `G'WX` 这一项时，只需进行快速的向量-矩阵乘法，而无需重复计算 `W %*% X`。

---
### 总结表格

| 变量名 | R 代码 | 数学表达式 | 运算维度 | 输出维度 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **`W_mat`** | `Diagonal(...)` | `W` | - | **`n x n`** | 权重对角矩阵 |
| **`X_t_W`** | `crossprod(X_mat, W_mat)` | `X'W` | `(p x n) * (n x n)` | **`p x n`** | `X`的转置与`W`的乘积 |
| **`XWX_mat`**| `X_t_W %*% X_mat` | `X'WX` | `(p x n) * (n x p)` | **`p x p`** | 信息矩阵 |
| **`XWX_inv`**| `solve(XWX_mat)` | `(X'WX)⁻¹` | `solve(p x p)` | **`p x p`** | 信息矩阵的逆 |
| **`WX_mat`** | `t(X_t_W)` | `WX` | `t(p x n)` | **`n x p`** | `W`与`X`的乘积 |

## Ordinal_GeneCentricCoding

## Ordinal_plof

1. **用功能注释来识别出哪些是pLoF变异**
2. **为后续的关联检验准备一个功能注释权重矩阵**
3. **质量控制genoFlipRV**
4. **关联分析OrdinalSTAAR**

## OrdinalSTAAR





## ACAT

## Burden

## SKAT

## OrdinalSTAAR_O