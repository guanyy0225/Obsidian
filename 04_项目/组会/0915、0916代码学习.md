

---

### `Ordinal_plof` å‡½æ•°å®Œæ•´ä»£ç è¯¦è§£

è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**é’ˆå¯¹ä¸€ä¸ªç‰¹å®šåŸºå› ï¼Œç¨³å¥åœ°æ‰§è¡Œ pLoF (predicted Loss-of-Function, åŠŸèƒ½ä¸§å¤±æ€§é¢„æµ‹) å˜å¼‚çš„é›†åˆå…³è”åˆ†æ**ã€‚å®ƒé€šè¿‡ä¸€ç³»åˆ—çš„ç­›é€‰ã€å‡€åŒ–å’Œæ£€æŸ¥æ­¥éª¤ï¼Œç¡®ä¿æœ€ç»ˆåˆ†æçš„å¯é æ€§ã€‚

---

#### **å‡½æ•°å®šä¹‰ä¸å‚æ•°**
```R
Ordinal_plof <- function(gene_name, genofile, objNull, genes_info, variant_type = NULL,
                                rare_maf_cutoff = 0.01, rare_num_cutoff = 2,
                                geno_missing_cutoff = 0.1,
                                geno_missing_imputation = c("mean","minor"),
                                min_maf_cutoff = 0, combine_ultra_rare = TRUE, ultra_rare_mac_cutoff = 20,
                                QC_label = "annotation/filter", Annotation_dir = "annotation/info/FunctionalAnnotation",
                                Annotation_name_catalog, Use_annotation_weights = TRUE, Annotation_name = NULL,
                                use_SPA = NULL, SPA_filter = TRUE, SPA_filter_cutoff = 0.05,
                                rm_long = TRUE, rm_long_cutoff = 3000,
                                instability_variance_cutoff = 10000,
                                verbose = FALSE) {
```
*   **ä½œç”¨**: å®šä¹‰äº†ä¸€ä¸ªåä¸º `Ordinal_plof` çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶å¤šä¸ªå‚æ•°æ¥æ§åˆ¶åˆ†æçš„å„ä¸ªæ–¹é¢ã€‚
*   **å…³é”®å‚æ•°**:
    *   `gene_name`: è¦åˆ†æçš„åŸºå› åç§° (å­—ç¬¦ä¸², e.g., "ADH1C")ã€‚
    *   `genofile`: ä¸€ä¸ªå·²ç»æ‰“å¼€çš„ `SeqArray` GDS æ–‡ä»¶å¯¹è±¡ï¼ŒåŒ…å«äº†åŸºå› å‹å’Œæ³¨é‡Šæ•°æ®ã€‚
    *   `objNull`: ä¸€ä¸ªåŒ…å«äº†ç©ºæ¨¡å‹ä¿¡æ¯çš„åˆ—è¡¨ï¼Œç”± `NullModel` å‡½æ•°ç”Ÿæˆã€‚
    *   `genes_info`: ä¸€ä¸ªæ•°æ®æ¡†ï¼Œæä¾›äº†åŸºå› åœ¨æŸ“è‰²ä½“ä¸Šçš„èµ·æ­¢ä½ç½®ã€‚
    *   `variant_type`: æŒ‡å®šåˆ†æçš„å˜å¼‚ç±»å‹ ("SNV", "Indel", æˆ– "variant" ä»£è¡¨ä¸¤è€…)ã€‚
    *   `rare_maf_cutoff`: å®šä¹‰ç½•è§å˜å¼‚çš„æ¬¡è¦ç­‰ä½åŸºå› é¢‘ç‡ (Minor Allele Frequency) é˜ˆå€¼ã€‚
    *   `rare_num_cutoff`: å¯åŠ¨åˆ†ææ‰€éœ€çš„æœ€å°‘å˜å¼‚æ•°é‡ã€‚
    *   `instability_variance_cutoff`: ç”¨äºè¯†åˆ«æ•°å€¼ä¸ç¨³å®šå˜å¼‚çš„æ–¹å·®é˜ˆå€¼ï¼Œæ˜¯ç¨³å¥æ€§æ£€æŸ¥çš„æ ¸å¿ƒå‚æ•°ã€‚
    *   å…¶ä»–å‚æ•°ç”¨äºæ§åˆ¶è´¨æ§ã€æ³¨é‡Šã€æ’è¡¥ç­‰ç»†èŠ‚ã€‚

---

#### **Part 1: å˜å¼‚ç­›é€‰ (Variant Selection)**
```R
  # --- Part 1: Variant Selection (pLoF Definition) ---
  phenotype.id = objNull$sample_ids
  if(is.null(use_SPA)) use_SPA = objNull$use_SPA

  seqResetFilter(genofile, verbose=FALSE)

  filter <- seqGetData(genofile, QC_label)

  if(variant_type=="variant")
  {
    SNVlist <- filter == "PASS"
  }

  if(variant_type=="SNV")
  {
    SNVlist <- (filter == "PASS") & SeqArray:::isSNV(genofile)
  }

  if(variant_type=="Indel")
  {
    SNVlist <- (filter == "PASS") & (!SeqArray:::isSNV(genofile))
  }

  position <- as.numeric(seqGetData(genofile, "position"))
  variant.id <- seqGetData(genofile, "variant.id")
  rm(filter)
  gc()

  kk <- which(genes_info$hgnc_symbol==gene_name)
  gene_info_kk = genes_info[kk, 1:2]

  sub_start_loc <- genes_info[kk,3]
  sub_end_loc <- genes_info[kk,4]

  is.in <- (SNVlist) & (position>=sub_start_loc) & (position<=sub_end_loc)
  variant.id.gene <- variant.id[is.in]

  seqSetFilter(genofile,variant.id=variant.id.gene,sample.id=phenotype.id)

  # Define pLoF variants
  GENCODE.EXONIC.Category <- seqGetData(genofile, paste0(Annotation_dir,Annotation_name_catalog$dir[which(Annotation_name_catalog$name=="GENCODE.EXONIC.Category")]))
  GENCODE.Category <- seqGetData(genofile, paste0(Annotation_dir,Annotation_name_catalog$dir[which(Annotation_name_catalog$name=="GENCODE.Category")]))
  variant.id.gene.current <- seqGetData(genofile, "variant.id")

  lof.in.plof <- (GENCODE.EXONIC.Category=="stopgain")|(GENCODE.EXONIC.Category=="stoploss")|(GENCODE.Category=="splicing")|(GENCODE.Category=="exonic;splicing")|(GENCODE.Category=="ncRNA_splicing")|(GENCODE.Category=="ncRNA_exonic;splicing")
  variant.id.plof <- variant.id.gene.current[lof.in.plof]

  if (length(variant.id.plof) < rare_num_cutoff) {
    message("Variants number of *plof* is less than ", rare_num_cutoff, ", skipping...")
    return(c(list("gene_info" = gene_info_kk, "category" = "plof"), list("OrdinalSTAAR_O" = NA)))
  }
  if (rm_long && length(variant.id.plof) > rm_long_cutoff) {
    message(paste0("Variants number of *plof* is more than ", rm_long_cutoff, ", skipping..."))
    return(c(list("gene_info" = gene_info_kk, "category" = "plof"), list("OrdinalSTAAR_O" = NA)))
  }

  seqSetFilter(genofile,variant.id=variant.id.plof,sample.id=phenotype.id)
```
*   **ä½œç”¨**: è¿™æ˜¯æ•°æ®ç­›é€‰çš„ç¬¬ä¸€é˜¶æ®µï¼Œç›®çš„æ˜¯ä»å…¨åŸºå› ç»„æ•°æ®ä¸­**ç²¾ç¡®åœ°æ‰¾å‡º**æˆ‘ä»¬æ„Ÿå…´è¶£çš„ã€ä½äºç›®æ ‡åŸºå› å†…çš„ pLoF å˜å¼‚ã€‚
*   **æ­¥éª¤**:
    1.  `phenotype.id = objNull$sample_ids`: ä»ç©ºæ¨¡å‹ä¸­è·å–éœ€è¦åˆ†æçš„æ ·æœ¬IDåˆ—è¡¨ã€‚
    2.  `seqResetFilter(...)`: æ¸…é™¤ GDS æ–‡ä»¶ä¸Šä»»ä½•å¯èƒ½æ®‹ç•™çš„æ—§è¿‡æ»¤å™¨ï¼Œç¡®ä¿æˆ‘ä»¬ä»ä¸€ä¸ªå¹²å‡€çš„çŠ¶æ€å¼€å§‹ã€‚è¿™æ˜¯è‰¯å¥½çš„é˜²å¾¡æ€§ç¼–ç¨‹ä¹ æƒ¯ã€‚
    3.  `filter <- seqGetData(...)`: è·å–æ‰€æœ‰å˜å¼‚çš„è´¨æ§æ ‡ç­¾ (e.g., "PASS")ã€‚
    4.  `if/else if`: æ ¹æ® `variant_type` å‚æ•°ï¼Œç»“åˆ `PASS` æ ‡ç­¾å’Œ `SeqArray:::isSNV()` å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªé€»è¾‘å‘é‡ `SNVlist` æ¥æ ‡è®°ç¬¦åˆåŸºæœ¬è´¨æ§å’Œç±»å‹çš„å˜å¼‚ã€‚
    5.  `position`, `variant.id`: è·å–æ‰€æœ‰å˜å¼‚çš„ä½ç½®å’ŒIDã€‚
    6.  `is.in <- ...`: ç»“åˆ `SNVlist` å’ŒåŸºå› çš„èµ·æ­¢ä½ç½®ï¼Œè¿›ä¸€æ­¥ç­›é€‰å‡ºä½äº `gene_name` åŸºå› åŒºåŸŸå†…çš„å˜å¼‚ã€‚
    7.  `seqSetFilter(...)`: åœ¨ GDS æ–‡ä»¶ä¸Šè®¾ç½®ä¸€ä¸ª**ä¸´æ—¶è¿‡æ»¤å™¨**ï¼Œåªå…³æ³¨ç›®æ ‡åŸºå› å†…çš„å˜å¼‚ï¼Œè¿™æå¤§åœ°æé«˜äº†åç»­ `seqGetData` çš„æ•ˆç‡ã€‚
    8.  `GENCODE... <- seqGetData(...)`: åœ¨åŸºå› åŒºåŸŸå†…ï¼Œè·å–æ‰€æœ‰å˜å¼‚çš„åŠŸèƒ½æ³¨é‡Šã€‚
    9.  `lof.in.plof <- ...`: è¿™æ˜¯**pLoF å®šä¹‰çš„æ ¸å¿ƒ**ã€‚å®ƒåˆ›å»ºäº†ä¸€ä¸ªé€»è¾‘å‘é‡ï¼Œæ ‡è®°é‚£äº›åŠŸèƒ½æ³¨é‡Šä¸º `stopgain` (ç»ˆæ­¢å¯†ç å­è·å¾—), `stoploss` (ç»ˆæ­¢å¯†ç å­ä¸¢å¤±), æˆ–å„ç§ `splicing` (å‰ªæ¥) çš„å˜å¼‚ã€‚
    10. `variant.id.plof <- ...`: æ ¹æ®ä¸Šé¢çš„é€»è¾‘å‘é‡ï¼Œå¾—åˆ°æœ€ç»ˆçš„ pLoF å˜å¼‚ ID åˆ—è¡¨ã€‚
    11. `if (length(...) ...)`: **åˆæ­¥æ£€æŸ¥ç‚¹**ã€‚æ£€æŸ¥æ‰¾åˆ°çš„ pLoF å˜å¼‚æ•°é‡æ˜¯å¦è¶³å¤Ÿï¼ˆä¸å°‘äº`rare_num_cutoff`ï¼‰ä¸”ä¸è¿‡å¤šï¼ˆä¸å¤šäº`rm_long_cutoff`ï¼‰ã€‚å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œå°±æ‰“å°ä¿¡æ¯å¹¶**æå‰è¿”å›**ï¼Œç»“æŸå½“å‰å‡½æ•°çš„æ‰§è¡Œã€‚
    12. `seqSetFilter(...)`: å†æ¬¡è®¾ç½®è¿‡æ»¤å™¨ï¼Œè¿™æ¬¡å°† GDS æ–‡ä»¶çš„ç„¦ç‚¹**ç²¾ç¡®åœ°**ç¼©å°åˆ°æœ€ç»ˆè¦åˆ†æçš„ pLoF å˜å¼‚é›†å’Œæ ·æœ¬é›†ä¸Šã€‚

---

#### **Part 2: åŸºå› å‹ä¸æ³¨é‡Šæå– (Genotype and Annotation Extraction)**
```R
  # --- Part 2: Genotype and Annotation Extraction ---
  Anno.Int.PHRED.sub <- NULL
  if(variant_type != "Indel" && Use_annotation_weights){
    anno_list <- lapply(Annotation_name, function(name) {
      if(name %in% Annotation_name_catalog$name) {
        dir <- Annotation_name_catalog$dir[which(Annotation_name_catalog$name==name)]
        seqGetData(genofile, paste0(Annotation_dir, dir))
      }
    })
    Anno.Int.PHRED.sub <- as.data.frame(do.call(cbind, anno_list))
    colnames(Anno.Int.PHRED.sub) <- Annotation_name[sapply(anno_list, function(x) !is.null(x))]
  }

  id.genotype <- seqGetData(genofile,"sample.id")
  id.genotype.merge <- data.frame(id.genotype, index=seq_along(id.genotype))
  phenotype.id.merge <- data.frame(phenotype.id)
  phenotype.id.merge <- dplyr::left_join(phenotype.id.merge, id.genotype.merge, by=c("phenotype.id"="id.genotype"))
  id.genotype.match <- phenotype.id.merge$index

  Geno <- seqGetData(genofile, "$dosage")[id.genotype.match, , drop=FALSE]
```
*   **ä½œç”¨**: ä» GDS æ–‡ä»¶ä¸­æå–å‡ºæˆ‘ä»¬æœ€ç»ˆéœ€è¦çš„ä¸¤ä¸ªæ ¸å¿ƒæ•°æ®ï¼š**åŠŸèƒ½æ³¨é‡Šåˆ†æ•°çŸ©é˜µ**å’Œ**åŸºå› å‹çŸ©é˜µ**ã€‚
*   **æ­¥éª¤**:
    1.  `if(variant_type != "Indel" && Use_annotation_weights)`: æ£€æŸ¥æ˜¯å¦éœ€è¦æå–åŠŸèƒ½æ³¨é‡Šï¼ˆé€šå¸¸ Indel æ²¡æœ‰è¿™äº›åˆ†æ•°ï¼‰ã€‚
    2.  `lapply(...)`: ä½¿ç”¨ `lapply` éå† `Annotation_name` åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ³¨é‡Šåï¼Œä» GDS æ–‡ä»¶ä¸­æå–å¯¹åº”çš„åˆ†æ•°å‘é‡ã€‚
    3.  `do.call(cbind, anno_list)`: å°†æ‰€æœ‰æå–å‡ºçš„æ³¨é‡Šåˆ†æ•°å‘é‡åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µ `Anno.Int.PHRED.sub`ã€‚è¿™æ¯” `for` å¾ªç¯æ›´ç®€æ´é«˜æ•ˆã€‚
    4.  `id.genotype.merge <- ...`: è¿™å‡ è¡Œä»£ç æ˜¯ä¸ºäº†ç¡®ä¿ä» GDS æ–‡ä»¶ä¸­æå–çš„åŸºå› å‹çŸ©é˜µçš„æ ·æœ¬é¡ºåºï¼Œä¸ç©ºæ¨¡å‹ä¸­çš„æ ·æœ¬é¡ºåº (`phenotype.id`) å®Œå…¨ä¸€è‡´ã€‚
    5.  `Geno <- ...`: æå–è¿™ç»„ pLoF å˜å¼‚åœ¨æ‰€æœ‰æ ·æœ¬ä¸­çš„åŸºå› å‹å‰‚é‡ï¼ˆdosageï¼‰æ•°æ®ï¼Œå½¢æˆä¸€ä¸ª `æ ·æœ¬ x å˜å¼‚` çš„çŸ©é˜µ `Geno`ã€‚

---

#### **Part 3: è¿‡æ»¤ã€æ’è¡¥ä¸ NA ç§»é™¤**
```R
  # --- Part 3: Filtering, Imputation, AND NA REMOVAL ---
  getGeno = genoFlipRV(Geno=Geno, geno_missing_imputation=geno_missing_imputation, geno_missing_cutoff=geno_missing_cutoff,
                       min_maf_cutoff=min_maf_cutoff, rare_maf_cutoff=rare_maf_cutoff, rare_num_cutoff=rare_num_cutoff)

  Geno = getGeno$Geno
  MAF = getGeno$G_summary$MAF
  MAC = getGeno$G_summary$MAC

  if(!is.null(Anno.Int.PHRED.sub)) {
    Anno.Int.PHRED.sub = Anno.Int.PHRED.sub[getGeno$include_index, , drop = FALSE]
  }

  # --- [THE FIX: Robustly handle NA in ANY annotation column] ---
  if (!is.null(Anno.Int.PHRED.sub)) {
    complete_anno_idx <- complete.cases(Anno.Int.PHRED.sub)
    if (sum(!complete_anno_idx) > 0) {
      message(paste0("INFO: Found and removed ", sum(!complete_anno_idx), " variant(s) with missing annotation scores."))
      Geno <- Geno[, complete_anno_idx, drop = FALSE]
      MAF <- MAF[complete_anno_idx]
      MAC <- MAC[complete_anno_idx]
      Anno.Int.PHRED.sub <- Anno.Int.PHRED.sub[complete_anno_idx, , drop = FALSE]
    }
  }
  # --- [END OF FIX] ---

  if (is.null(dim(Geno)) || ncol(Geno) < rare_num_cutoff) {
    message("After all filtering, variants number of *plof* is less than ", rare_num_cutoff, ", skipping...")
    return(c(list("gene_info" = gene_info_kk, "category" = "plof"), list("OrdinalSTAAR_O" = NA)))
  }
```
*   **ä½œç”¨**: å¯¹åŸå§‹çš„åŸºå› å‹å’Œæ³¨é‡Šæ•°æ®è¿›è¡Œæœ€åçš„æ¸…æ´—å’Œè´¨æ§ã€‚
*   **æ­¥éª¤**:
    1.  `getGeno = genoFlipRV(...)`: è°ƒç”¨ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œå¯¹åŸºå› å‹çŸ©é˜µ `Geno` è¿›è¡Œå¤„ç†ï¼ŒåŒ…æ‹¬å¯¹ç¼ºå¤±åŸºå› å‹è¿›è¡Œæ’è¡¥ã€æ ¹æ®ç­‰ä½åŸºå› é¢‘ç‡ç¿»è½¬ç¼–ç ã€ä»¥åŠç§»é™¤ä¸ç¬¦åˆç½•è§å˜å¼‚æ ‡å‡†çš„ä½ç‚¹ã€‚
    2.  `Geno = getGeno$Geno ...`: ç”¨ `genoFlipRV` è¿”å›çš„â€œå¹²å‡€â€æ•°æ®æ›´æ–° `Geno`, `MAF`, `MAC`, å’Œ `Anno.Int.PHRED.sub`ã€‚
    3.  `if (!is.null(Anno.Int.PHRED.sub))`: **ç¬¬ä¸€ä¸ªå…³é”®ä¿®å¤**ã€‚ä½¿ç”¨ `complete.cases()` æ£€æŸ¥æ³¨é‡ŠçŸ©é˜µ `Anno.Int.PHRED.sub` æ˜¯å¦æœ‰ä»»ä½•åŒ…å« `NA` çš„è¡Œã€‚
    4.  å¦‚æœå‘ç° `NA`ï¼Œæ‰“å°ä¿¡æ¯å¹¶ç§»é™¤è¿™äº›å˜å¼‚ï¼ˆä»¥åŠ `Geno`, `MAF`, `MAC` ä¸­å¯¹åº”çš„åˆ—ï¼‰ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚
    5.  `if (is.null(dim(Geno)) ...)`: **ç¬¬äºŒæ¬¡æ£€æŸ¥ç‚¹**ã€‚åœ¨æ‰€æœ‰è¿‡æ»¤åï¼Œå†æ¬¡æ£€æŸ¥å‰©ä¸‹çš„å˜å¼‚æ•°é‡æ˜¯å¦è¿˜è¶³å¤Ÿã€‚å¦‚æœä¸å¤Ÿï¼Œæ‰“å°ä¿¡æ¯å¹¶**æå‰è¿”å›**ã€‚

---

#### **Part 4: æ•°å€¼ç¨³å®šæ€§æ£€æŸ¥ (Detect and Remove Unstable Variants)**
```R
  # --- Part 4: Detect and Remove Unstable Variants ---
  message("Performing pre-check for numerically unstable variants...")
  pre_check_stats <- Ordinal_exactScore(objNull = objNull, G_mat = Geno, use_SPA = FALSE)

  unstable_idx <- which(pre_check_stats$result$Variance > instability_variance_cutoff)

  if (length(unstable_idx) > 0) {
    message(paste0("WARNING: Found and removed ", length(unstable_idx), " unstable variant(s)."))

    stable_idx <- setdiff(1:ncol(Geno), unstable_idx)

    Geno <- Geno[, stable_idx, drop = FALSE]
    MAF <- MAF[stable_idx]
    MAC <- MAC[stable_idx]

    if (!is.null(Anno.Int.PHRED.sub)) {
      Anno.Int.PHRED.sub <- Anno.Int.PHRED.sub[stable_idx, , drop = FALSE]
    }

    if (ncol(Geno) < rare_num_cutoff) {
      message("After removing unstable variants, remaining number is less than ", rare_num_cutoff, ", skipping...")
      return(c(list("gene_info" = gene_info_kk, "category" = "plof"), list("OrdinalSTAAR_O" = NA)))
    }
  } else {
    message("No unstable variants found.")
  }
```
*   **ä½œç”¨**: è¿™æ˜¯**ç¬¬äºŒä¸ªå…³é”®ä¿®å¤**ï¼Œä¸»åŠ¨é¢„é˜²ç”±ï¼ˆå‡†ï¼‰å®Œå…¨åˆ†ç¦»å¯¼è‡´çš„åˆ†æå¤±è´¥ã€‚
*   **æ­¥éª¤**:
    1.  `pre_check_stats <- Ordinal_exactScore(...)`: å¯¹å½“å‰â€œå¹²å‡€â€çš„åŸºå› å‹çŸ©é˜µ `Geno` ä¸­çš„**æ¯ä¸€ä¸ªå˜å¼‚**ï¼Œå•ç‹¬è®¡ç®—å…¶å¾—åˆ†æ£€éªŒçš„ç»Ÿè®¡é‡ã€‚
    2.  `unstable_idx <- which(...)`: æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜å¼‚çš„æ–¹å·® (`Variance`) è¶…è¿‡äº†é¢„è®¾çš„é˜ˆå€¼ (`instability_variance_cutoff`)ã€‚æå¤§çš„æ–¹å·®æ˜¯æ•°æ®åˆ†ç¦»çš„å¼ºçƒˆä¿¡å·ã€‚
    3.  `if (length(unstable_idx) > 0)`: å¦‚æœæ‰¾åˆ°äº†ä¸ç¨³å®šçš„å˜å¼‚ï¼š
        *   æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚
        *   å°†è¿™äº›ä¸ç¨³å®šçš„å˜å¼‚ä» `Geno`, `MAF`, `MAC`, å’Œ `Anno.Int.PHRED.sub` ä¸­ç§»é™¤ã€‚
        *   **ç¬¬ä¸‰æ¬¡ï¼ˆä¹Ÿæ˜¯æœ€åä¸€æ¬¡ï¼‰æ£€æŸ¥ç‚¹**ï¼šå†æ¬¡æ£€æŸ¥ç§»é™¤åå‰©ä¸‹çš„å˜å¼‚æ•°é‡æ˜¯å¦è¿˜è¶³å¤Ÿã€‚å¦‚æœä¸å¤Ÿï¼Œæ‰“å°ä¿¡æ¯å¹¶**æå‰è¿”å›**ã€‚
    4.  `else`: å¦‚æœæ²¡æœ‰å‘ç°ä¸ç¨³å®šå˜å¼‚ï¼Œæ‰“å°ä¸€æ¡â€œä¸€åˆ‡æ­£å¸¸â€çš„ä¿¡æ¯ã€‚

---

#### **Part 5: æœ€ç»ˆåˆ†æä¸è¿”å› (Run the Final Analysis and Return)**
```R
  # --- Part 5: Run the Final Analysis on Cleaned Data ---
  result.plof = try(OrdinalSTAAR(Geno, MAF, MAC, objNull, annotation_phred = Anno.Int.PHRED.sub,
                                 rare_maf_cutoff, rare_num_cutoff, combine_ultra_rare, ultra_rare_mac_cutoff,
                                 use_SPA, SPA_filter, SPA_filter_cutoff, verbose), silent = FALSE)

  if (inherits(result.plof, "try-error")) {
    result.plof = list("OrdinalSTAAR_O" = NA)
  }

  seqResetFilter(genofile, verbose=FALSE)

  result = c(list("gene_info" = gene_info_kk, "category" = "plof"), result.plof)

  return(result)
}
```
*   **ä½œç”¨**: æ‰§è¡Œæ ¸å¿ƒçš„å…³è”åˆ†æå¹¶è¿”å›æœ€ç»ˆç»“æœã€‚
*   **æ­¥éª¤**:
    1.  `result.plof = try(OrdinalSTAAR(...))`: å°†ç»è¿‡**å±‚å±‚ç­›é€‰å’Œå‡€åŒ–**çš„æœ€ç»ˆå˜å¼‚é›†ä¼ é€’ç»™ `OrdinalSTAAR` å‡½æ•°ï¼Œè¿›è¡Œé›†åˆå…³è”æ£€éªŒï¼ˆåŒ…æ‹¬ Burden, SKAT, ACAT, STAAR-O ç­‰ï¼‰ã€‚
    2.  `try(...)`: å°†æ•´ä¸ªè°ƒç”¨åŒ…è£¹åœ¨ `try` å—ä¸­ï¼Œä½œä¸ºæœ€åä¸€é“é˜²çº¿ã€‚ä¸‡ä¸€ `OrdinalSTAAR` å†…éƒ¨è¿˜æ˜¯å‘ç”Ÿäº†æ„æ–™ä¹‹å¤–çš„é”™è¯¯ï¼Œç¨‹åºä¹Ÿä¸ä¼šå´©æºƒã€‚
    3.  `if (inherits(result.plof, "try-error"))`: æ£€æŸ¥ `OrdinalSTAAR` æ˜¯å¦å¤±è´¥ã€‚å¦‚æœå¤±è´¥ï¼Œå°†ç»“æœè®¾ä¸º `NA`ã€‚
    4.  `seqResetFilter(...)`: åœ¨å‡½æ•°ç»“æŸå‰ï¼Œå†æ¬¡æ¸…é™¤ GDS æ–‡ä»¶ä¸Šçš„è¿‡æ»¤å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚
    5.  `result = c(...)`: å°†åˆ†æç»“æœä¸åŸºå› ä¿¡æ¯ã€ç±»åˆ«ä¿¡æ¯åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„åˆ—è¡¨ã€‚
    6.  `return(result)`: è¿”å›æœ€ç»ˆçš„ç»“æœå¯¹è±¡ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªåŒ…å«ä¸°å¯Œä¿¡æ¯çš„åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨æŸä¸ªæ£€æŸ¥ç‚¹å¤±è´¥åè¿”å›çš„ `NA`ã€‚



## OrdinalSTAAR

### ä»£ç é€æ®µè§£é‡Š

#### **1. è¾“å…¥éªŒè¯ä¸æ•°æ®é¢„å¤„ç†**
```R
OrdinalSTAAR = function(Geno, MAF = NULL, MAC = NULL, objNull, annotation_phred = NULL, ...) {

  if (!inherits(Geno, "matrix") && !inherits(Geno, "Matrix")) {
    stop("Genotype is not a matrix!")
  }
  
  if(inherits(Geno, "sparseMatrix")){
    Geno = as.matrix(Geno)
  }
  
  # ... (æ£€æŸ¥å˜å¼‚æ•°é‡å’Œæ³¨é‡Šç»´åº¦) ...
  
  if (is.null(MAF) | is.null(MAC)) {
    genotype = genoFlip(Geno = Geno)
    # ... (è®¡ç®— MAF å’Œ MAC) ...
    rm(genotype)
  }
  
  RV_label = as.vector((MAF < rare_maf_cutoff)&(MAF > 0))
  Geno = Geno[ ,RV_label]
  MAF = MAF[RV_label]
  MAC = MAC[RV_label]
  annotation_phred <- annotation_phred[RV_label,,drop=FALSE]
  
  if(sum(RV_label) < rare_num_cutoff) { ... }
```
*   **ä½œç”¨**: ç¡®ä¿è¾“å…¥çš„æ•°æ®æ ¼å¼æ­£ç¡®ï¼Œå¹¶è¿›è¡Œæœ€ç»ˆçš„ç½•è§å˜å¼‚ç­›é€‰ã€‚
*   **æ­¥éª¤**:
    1.  `if (!inherits(Geno, ...))`: æ£€æŸ¥ `Geno` æ˜¯å¦æ˜¯ä¸€ä¸ªçŸ©é˜µã€‚
    2.  `if (inherits(Geno, "sparseMatrix"))`: å¦‚æœæ˜¯ç¨€ç–çŸ©é˜µï¼Œå°†å…¶è½¬æ¢ä¸ºæ ‡å‡†çš„ç¨ å¯†çŸ©é˜µã€‚
    3.  `if (is.null(MAF) | is.null(MAC))`: å¦‚æœç”¨æˆ·æ²¡æœ‰æä¾› MAF (Minor Allele Frequency) æˆ– MAC (Minor Allele Count)ï¼Œå‡½æ•°ä¼šè°ƒç”¨ `genoFlip` äº²è‡ªè®¡ç®—å®ƒä»¬ã€‚
    4.  `RV_label = ...`: åˆ›å»ºä¸€ä¸ªé€»è¾‘å‘é‡ï¼Œæ ‡è®°é‚£äº› MAF ä½äº `rare_maf_cutoff` çš„**ç½•è§å˜å¼‚**ã€‚
    5.  `Geno = Geno[ ,RV_label]`: **æ‰§è¡Œæœ€ç»ˆç­›é€‰**ã€‚ä» `Geno`, `MAF`, `MAC`, å’Œ `annotation_phred` ä¸­åªä¿ç•™ç½•è§å˜å¼‚ã€‚
    6.  `if(sum(RV_label) < rare_num_cutoff)`: **æœ€ç»ˆæ£€æŸ¥ç‚¹**ã€‚ç¡®ä¿åœ¨ç­›é€‰åï¼Œç½•è§å˜å¼‚çš„æ•°é‡ä»ç„¶è¶³å¤Ÿè¿›è¡Œåˆ†æã€‚

---

#### **2. ç”Ÿæˆæƒé‡ (Weight Generation)**
```R
    annotation_rank <- 1 - 10^(-annotation_phred/10)

    w_1 <- dbeta(MAF, 1, 25)
    w_2 <- dbeta(MAF, 1, 1)

    # ... (ç”Ÿæˆ w_a_1 å’Œ w_a_2) ...

    if(dim(annotation_phred)[2] == 0){
      # ... (åªä½¿ç”¨ MAF æƒé‡) ...
      w_B <- w_S <- as.matrix(cbind(w_1, w_2))
      w_A <- as.matrix(cbind(w_a_1, w_a_2))
    }else{
      # ... (ç»“åˆ MAF å’ŒåŠŸèƒ½æ³¨é‡Šæƒé‡) ...
      w_B = as.matrix(cbind(w_1, annotation_rank*w_1, w_2, annotation_rank*w_2))
      w_S = as.matrix(cbind(w_1, sqrt(annotation_rank)*w_1, w_2, sqrt(annotation_rank)*w_2))
      w_A = as.matrix(cbind(w_a_1, annotation_rank*w_a_1, w_a_2, annotation_rank*w_a_2))
    }
```
*   **ä½œç”¨**: è¿™æ˜¯ STAAR æ–¹æ³•çš„**æ ¸å¿ƒæ€æƒ³**æ‰€åœ¨ã€‚å®ƒä¸ä¾èµ–å•ä¸€çš„å‡è®¾ï¼Œè€Œæ˜¯ç”Ÿæˆ**å¤šç§æƒé‡æ–¹æ¡ˆ**æ¥æ•æ‰ä¸åŒç±»å‹çš„é—ä¼ æ•ˆåº”ã€‚
*   **æ­¥éª¤**:
    1.  `annotation_rank <- ...`: å°† PHRED æ ¼å¼çš„åŠŸèƒ½æ³¨é‡Šåˆ†æ•°ï¼ˆå¦‚ CADD åˆ†æ•°ï¼‰è½¬æ¢ä¸º 0 åˆ° 1 ä¹‹é—´çš„â€œåŠŸèƒ½é‡è¦æ€§â€æƒé‡ã€‚
    2.  `w_1 <- dbeta(MAF, 1, 25)`: åŸºäº Beta åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼Œä¸ºæ¯ä¸ªå˜å¼‚ç”Ÿæˆä¸€ä¸ªæƒé‡ã€‚è¿™ä¸ªæƒé‡æ–¹æ¡ˆ**ç»™äºˆæç½•è§çš„å˜å¼‚ï¼ˆMAF æ¥è¿‘ 0ï¼‰éå¸¸é«˜çš„æƒé‡**ã€‚
    3.  `w_2 <- dbeta(MAF, 1, 1)`: å¦ä¸€ä¸ª Beta åˆ†å¸ƒæƒé‡æ–¹æ¡ˆï¼Œå®ƒå¯¹æ‰€æœ‰ MAF çš„å˜å¼‚ç»™äºˆ**å‡ ä¹ç›¸åŒçš„æƒé‡**ï¼ˆç±»ä¼¼äºæ— æƒé‡ï¼‰ã€‚
    4.  `if/else`:
        *   **`if` (æ— åŠŸèƒ½æ³¨é‡Š)**: åªä½¿ç”¨ä¸¤ç§åŸºäº MAF çš„æƒé‡ (`w_1`, `w_2`) åˆ†åˆ«ç”¨äº Burden, SKAT, ACAT æ£€éªŒã€‚
        *   **`else` (æœ‰åŠŸèƒ½æ³¨é‡Š)**: **å°† MAF æƒé‡ä¸åŠŸèƒ½æ³¨é‡Šæƒé‡ç›¸ä¹˜**ï¼Œåˆ›é€ å‡ºç»„åˆæƒé‡ã€‚ä¾‹å¦‚ `annotation_rank*w_1` æ„å‘³ç€â€œæ—¢ç½•è§åˆè¢«é¢„æµ‹ä¸ºåŠŸèƒ½é‡è¦çš„å˜å¼‚å°†è·å¾—æœ€é«˜æƒé‡â€ã€‚
    5.  **`w_B`, `w_S`, `w_A`**: æœ€ç»ˆç”Ÿæˆä¸‰ä¸ªæƒé‡çŸ©é˜µï¼Œåˆ†åˆ«ç”¨äº Burden, SKAT, å’Œ ACAT æ£€éªŒã€‚æ¯ä¸ªçŸ©é˜µçš„åˆ—ä»£è¡¨ä¸€ç§ä¸åŒçš„åŠ æƒå‡è®¾ã€‚æ³¨æ„ï¼Œ`w_S` (SKAT æƒé‡) å¯¹åŠŸèƒ½æ³¨é‡Šæƒé‡å–äº†å¹³æ–¹æ ¹ï¼Œè¿™æ˜¯ SKAT æ–¹æ³•çš„æ ‡å‡†åšæ³•ã€‚

---

#### **3. è°ƒç”¨æ ¸å¿ƒåˆ†æå‡½æ•°**
```R
    pvalues <- OrdinalSTAAR_O(Geno = Geno, objNull = objNull, annotation_rank, MAC = MAC,
                           use_SPA = use_SPA, SPA_filter = SPA_filter, SPA_filter_cutoff = SPA_filter_cutoff,
                           weight_A = w_A, weight_B = w_B, weight_S = w_S,
                           combine_ultra_rare, ultra_rare_mac_cutoff, verbose = verbose)
```
*   **ä½œç”¨**: å°†æ‰€æœ‰å‡†å¤‡å¥½çš„æ•°æ®ï¼ˆåŸºå› å‹ã€ç©ºæ¨¡å‹ã€æƒé‡çŸ©é˜µç­‰ï¼‰ä¼ é€’ç»™ä¸€ä¸ªæ›´åº•å±‚çš„â€œå·¥ä½œæ¯æœºâ€å‡½æ•° `OrdinalSTAAR_O`ã€‚
*   **`OrdinalSTAAR_O` çš„èŒè´£** (æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°å®ƒçš„ä»£ç ï¼Œä½†å¯ä»¥æ¨æ–­):
    1.  å®ƒä¼šæ¥æ”¶æ‰€æœ‰çš„æƒé‡çŸ©é˜µ (`w_B`, `w_S`, `w_A`)ã€‚
    2.  å®ƒä¼š**å¾ªç¯**éå†æ¯ä¸ªæƒé‡æ–¹æ¡ˆï¼ˆæ¯ä¸ªæƒé‡çŸ©é˜µçš„æ¯ä¸€åˆ—ï¼‰ã€‚
    3.  åœ¨æ¯ä¸ªå¾ªç¯ä¸­ï¼Œå®ƒä¼šè°ƒç”¨æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„ `OrdinalBurden`, `OrdinalSKAT`, `OrdinalACAT` å‡½æ•°æ¥è®¡ç®—å¯¹åº”æ£€éªŒçš„ p å€¼ã€‚
    4.  æœ€åï¼Œå®ƒä¼šä½¿ç”¨ ACAT æ–¹æ³•å°†**æ‰€æœ‰**è¿™äº›æ¥è‡ªä¸åŒæ£€éªŒå’Œä¸åŒæƒé‡æ–¹æ¡ˆçš„ p å€¼å†æ¬¡ç»„åˆï¼Œå¾—åˆ°ä¸€ä¸ª**æœ€ç»ˆçš„ã€æœ€æ€»æ‹¬çš„ STAAR-O (omnibus) p å€¼**ã€‚
    5.  å®ƒè¿”å›ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰ p å€¼ï¼ˆå•ä¸ªæ£€éªŒçš„ã€ç»„åˆçš„ã€æ€»æ‹¬çš„ï¼‰çš„å¤æ‚ç»“æœå¯¹è±¡ã€‚

---

#### **4. æ•´ç†å¹¶è¿”å›ç»“æœ**
```R
    cMAC <- sum(Geno)

    return(c(pvalues,
             list(num_variant = sum(RV_label),
                  cMAC = cMAC,
                  MAF = MAF)))
```
*   **ä½œç”¨**: å°†ä» `OrdinalSTAAR_O` è·å¾—çš„ p å€¼ç»“æœä¸ä¸€äº›é¢å¤–çš„æè¿°æ€§ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœ€ç»ˆåˆ†æçš„å˜å¼‚æ•°é‡ã€ç´¯ç§¯ç­‰ä½åŸºå› è®¡æ•° cMACï¼‰åˆå¹¶ï¼Œç„¶åè¿”å›ã€‚
*   è¿™ä¸ªæœ€ç»ˆè¿”å›çš„åˆ—è¡¨å¯¹è±¡å°±æ˜¯æˆ‘ä»¬åœ¨ä¸»åˆ†æå¾ªç¯ä¸­æ¥æ”¶åˆ°çš„ `analysis_results_list_obj`ã€‚




## Burdenæ£€éªŒ

### Burden æ£€éªŒçš„æ•°å­¦åŸç†

**æ ¸å¿ƒæ€æƒ³ (Core Idea)**

Burden æ£€éªŒï¼Œä¹Ÿç§°ä¸ºå¡Œç¼©æ£€éªŒ (Collapsing Test)ï¼Œæ˜¯ä¸€ç§ç”¨äºç½•è§å˜å¼‚é›†åˆå…³è”åˆ†æçš„ç®€å•è€Œå¼ºå¤§çš„æ–¹æ³•ã€‚å®ƒçš„åŸºæœ¬å‡è®¾æ˜¯ï¼š**åœ¨ä¸€ä¸ªç‰¹å®šçš„åŸºå› æˆ–åŒºåŸŸå†…ï¼Œæ‰€æœ‰ï¼ˆæˆ–å¤§éƒ¨åˆ†ï¼‰è‡´ç—…çš„ç½•è§å˜å¼‚éƒ½ä»¥ç›¸åŒçš„æ–¹å‘å½±å“æ€§çŠ¶**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬è¦ä¹ˆéƒ½æ˜¯æœ‰å®³çš„ï¼ˆå¢åŠ ç–¾ç—…é£é™©æˆ–æŸä¸ªè¡¨å‹å€¼ï¼‰ï¼Œè¦ä¹ˆéƒ½æ˜¯ä¿æŠ¤æ€§çš„ï¼ˆé™ä½é£é™©æˆ–è¡¨å‹å€¼ï¼‰ã€‚

åŸºäºè¿™ä¸ªå‡è®¾ï¼ŒBurden æ£€éªŒå°†ä¸€ä¸ªåŒºåŸŸå†…å¤šä¸ªç½•è§å˜å¼‚çš„ä¿¡æ¯â€œå¡Œç¼©â€æˆä¸€ä¸ªå•ä¸€çš„é—ä¼ å¾—åˆ†ï¼Œç„¶åæ£€éªŒè¿™ä¸ªæ€»çš„â€œé—ä¼ è´Ÿæ‹…â€æ˜¯å¦ä¸æ€§çŠ¶ç›¸å…³ã€‚

**æ•°å­¦æ¨å¯¼ (Mathematical Derivation)**

æˆ‘ä»¬ä»å•ç‚¹å˜å¼‚çš„å¾—åˆ†æ£€éªŒ (Score Test) å‡ºå‘ã€‚å¯¹äºç¬¬ `j` ä¸ªå˜å¼‚ï¼Œå…¶å¾—åˆ†ç»Ÿè®¡é‡ `U_j` è¡¡é‡äº†å®ƒçš„åŸºå› å‹ `G_j` ä¸æ€§çŠ¶æ®‹å·®ä¹‹é—´çš„åæ–¹å·®ã€‚`U_j` è¿‘ä¼¼æœä»ä¸€ä¸ªå‡å€¼ä¸º 0ï¼Œæ–¹å·®ä¸º `V_jj` çš„æ­£æ€åˆ†å¸ƒã€‚

1.  **å®šä¹‰é—ä¼ è´Ÿæ‹… (Defining the Genetic Burden)**

    æˆ‘ä»¬ä¸å•ç‹¬æ£€éªŒæ¯ä¸ª `U_j`ï¼Œè€Œæ˜¯å°†å®ƒä»¬çº¿æ€§ç»„åˆèµ·æ¥ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªå˜å¼‚ `j` (ä» 1 åˆ° `m`) åˆ†é…ä¸€ä¸ªæƒé‡ `w_j`ï¼Œç„¶åå°†å®ƒä»¬çš„å¾—åˆ†åŠ æƒæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªæ€»çš„ Burden Scoreï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º $U_B$ã€‚

    $$
    U_B = \sum_{j=1}^{m} w_j U_j
    $$

    åœ¨ R ä»£ç ä¸­ï¼Œè¿™å¯¹åº”äº `Score_k <- sum(Score * weight_k)`ï¼Œå…¶ä¸­ `Score` æ˜¯ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰ `U_j` çš„å‘é‡ã€‚

2.  **è®¡ç®—è´Ÿæ‹…å¾—åˆ†çš„æ–¹å·® (Calculating the Variance of the Burden Score)**

    ç”±äºå„ä¸ªå˜å¼‚çš„å¾—åˆ†ç»Ÿè®¡é‡ `U_j` ä¹‹é—´å¯èƒ½å­˜åœ¨ç›¸å…³æ€§ï¼ˆå› ä¸ºè¿é”ä¸å¹³è¡¡ LDï¼‰ï¼Œ`U_B` çš„æ–¹å·®ä¸ä»…ä»…æ˜¯å„ä¸ªæ–¹å·®çš„åŠ æƒå’Œã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å®ƒä»¬ä¹‹é—´çš„åæ–¹å·®ã€‚

    è®¾ `V` æ˜¯æ‰€æœ‰ `m` ä¸ªå˜å¼‚çš„å¾—åˆ†ç»Ÿè®¡é‡çš„ $m \times m$ åæ–¹å·®çŸ©é˜µï¼Œå…¶ä¸­å¯¹è§’çº¿å…ƒç´  $V_{jj}$ æ˜¯ç¬¬ `j` ä¸ªå˜å¼‚çš„æ–¹å·®ï¼Œéå¯¹è§’çº¿å…ƒç´  $V_{jk}$ æ˜¯ç¬¬ `j` å’Œç¬¬ `k` ä¸ªå˜å¼‚å¾—åˆ†çš„åæ–¹å·®ã€‚
    è®¾ `w` æ˜¯ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰æƒé‡ $w_j$ çš„ $m \times 1$ åˆ—å‘é‡ã€‚

    æ ¹æ®çº¿æ€§ç»„åˆçš„æ–¹å·®å…¬å¼ï¼Œ`U_B` çš„æ–¹å·® $Var(U_B)$ å¯ä»¥è¡¨ç¤ºä¸ºï¼š

    $$
    Var(U_B) = \mathbf{w}^T \mathbf{V} \mathbf{w} = \sum_{j=1}^{m} \sum_{k=1}^{m} w_j w_k V_{jk}
    $$

    åœ¨ R ä»£ç ä¸­ï¼Œè¿™å¯¹åº”äº `Variance_k <- as.vector(crossprod(weight_k, Covariance %*% weight_k))`ã€‚

3.  **æ„å»ºæ£€éªŒç»Ÿè®¡é‡ (Constructing the Test Statistic)**

    åœ¨é›¶å‡è®¾ï¼ˆè¯¥åŸºå› ä¸æ€§çŠ¶æ— å…³ï¼‰ä¸‹ï¼Œæ€»çš„ Burden Score $U_B$ è¿‘ä¼¼æœä»ä¸€ä¸ªå‡å€¼ä¸º 0 çš„æ­£æ€åˆ†å¸ƒï¼š

    $$
    U_B \sim N(0, \mathbf{w}^T \mathbf{V} \mathbf{w})
    $$

    å› æ­¤ï¼Œæ ‡å‡†åŒ–çš„æ£€éªŒç»Ÿè®¡é‡ `Z` æœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼Œè€Œå®ƒçš„å¹³æ–¹åˆ™æœä»è‡ªç”±åº¦ä¸º 1 çš„å¡æ–¹ ($\chi^2$) åˆ†å¸ƒï¼š

    $$
    Z^2 = \frac{U_B^2}{Var(U_B)} = \frac{\left( \sum_{j=1}^{m} w_j U_j \right)^2}{\mathbf{w}^T \mathbf{V} \mathbf{w}} \sim \chi^2_1
    $$

    åœ¨ R ä»£ç ä¸­ï¼Œè¿™å¯¹åº”äº `pchisq(Score_k^2 / Variance_k, df = 1, lower.tail = FALSE)`ã€‚

**æƒé‡çš„ä½œç”¨ (The Role of Weights)**
æƒé‡ `w_j` éå¸¸é‡è¦ã€‚é€šå¸¸ï¼Œæƒé‡ä¼šåŸºäºå˜å¼‚çš„é¢‘ç‡ï¼ˆå¦‚ `dbeta(MAF, 1, 25)`ï¼Œç»™äºˆæ›´ç½•è§çš„å˜å¼‚æ›´é«˜æƒé‡ï¼‰å’Œ/æˆ–å…¶é¢„æµ‹çš„åŠŸèƒ½é‡è¦æ€§ï¼ˆå¦‚ CADD åˆ†æ•°ï¼‰ã€‚

---

### `OrdinalBurden` R ä»£ç è§£é‡Š

ä¸‹é¢æ˜¯å¯¹æ‚¨æä¾›çš„ã€ç»è¿‡ä¿®æ­£çš„ `OrdinalBurden` å‡½æ•°çš„é€æ®µè§£é‡Šã€‚

```R
OrdinalBurden <- function(Score, Covariance, weight) {

  # 1. Input Validation
  if (length(Score) != nrow(Covariance) || nrow(Covariance) != ncol(Covariance) || nrow(weight) != length(Score)) {
    stop("Dimension mismatch among Score, Covariance, and weight.")
  }
```
*   **ä½œç”¨**: è¿™æ˜¯**å®‰å…¨æ£€æŸ¥**ã€‚å®ƒç¡®ä¿ä¼ å…¥çš„ `Score` å‘é‡ã€`Covariance` çŸ©é˜µå’Œ `weight` çŸ©é˜µçš„ç»´åº¦æ˜¯ç›¸äº’åŒ¹é…çš„ã€‚`Score` çš„é•¿åº¦ã€`Covariance` çš„è¡Œ/åˆ—æ•°ã€ä»¥åŠ `weight` çš„è¡Œæ•°éƒ½åº”è¯¥ç­‰äºåŸºå› ä¸­çš„å˜å¼‚æ•°é‡ã€‚è¿™å¯ä»¥é˜²æ­¢å› ä¸ºä¸Šæ¸¸é”™è¯¯å¯¼è‡´è®¡ç®—å‡ºæ— æ„ä¹‰çš„ç»“æœã€‚

```R
  # 2. More efficient calculation (using apply family)
  # This avoids the inefficient loop.
  calculate_burden_p <- function(weight_k) {
    Score_k <- sum(Score * weight_k)
    Variance_k <- as.vector(crossprod(weight_k, Covariance %*% weight_k))
```
*   **ä½œç”¨**: è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨è¾…åŠ©å‡½æ•° `calculate_burden_p`ï¼Œå®ƒå°è£…äº†å¯¹**å•ä¸€æƒé‡æ–¹æ¡ˆ**è®¡ç®— Burden p å€¼çš„å®Œæ•´é€»è¾‘ã€‚
*   `Score_k <- sum(Score * weight_k)`: è¿™å®ç°äº† $U_B = \sum w_j U_j$ã€‚å®ƒå°†æ‰€æœ‰å•ä¸ªå˜å¼‚çš„å¾—åˆ† `Score` æŒ‰å½“å‰æƒé‡æ–¹æ¡ˆ `weight_k` è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ€»çš„ Burden Scoreã€‚
*   `Variance_k <- ...`: è¿™å®ç°äº† $Var(U_B) = \mathbf{w}^T \mathbf{V} \mathbf{w}$ã€‚å®ƒä½¿ç”¨çŸ©é˜µä¹˜æ³•æ¥è®¡ç®— `Score_k` çš„æ–¹å·®ï¼Œè€ƒè™‘äº†æ‰€æœ‰å˜å¼‚é—´çš„åæ–¹å·®ã€‚

```R
    # 3. Add a safeguard for variance
    if (Variance_k <= 1e-8) { # Use a small threshold
      return(1.0) # Return a non-significant p-value if variance is effectively zero
    }

    pchisq(Score_k^2 / Variance_k, df = 1, lower.tail = FALSE)
  }
```
*   **ä½œç”¨**: è¿™æ˜¯**ç¨³å¥æ€§ä¿éšœ**ã€‚
*   `if (Variance_k <= 1e-8)`: æ£€æŸ¥è®¡ç®—å‡ºçš„æ–¹å·®æ˜¯å¦ä¸ºé›¶æˆ–ä¸€ä¸ªæå°çš„æ•°ã€‚è¿™ç§æƒ…å†µå¯èƒ½å› ä¸ºå˜å¼‚é—´çš„é«˜åº¦å…±çº¿æ€§æˆ–æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜è€Œå‘ç”Ÿã€‚
*   `return(1.0)`: å¦‚æœæ–¹å·®ä¸ºé›¶ï¼Œåˆ™æ— æ³•è¿›è¡Œé™¤æ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿”å›ä¸€ä¸ªä¸æ˜¾è‘—çš„ p å€¼ (1.0) æ˜¯ä¸€ä¸ªå®‰å…¨çš„å¤„ç†æ–¹å¼ï¼Œé¿å…äº†ç¨‹åºå´©æºƒã€‚
*   `pchisq(...)`: å¦‚æœæ–¹å·®æ­£å¸¸ï¼Œå°±è®¡ç®— $\chi^2$ ç»Ÿè®¡é‡å¹¶ä»è‡ªç”±åº¦ä¸º1çš„å¡æ–¹åˆ†å¸ƒä¸­å¾—åˆ° p å€¼ã€‚

```R
  pval_B <- apply(weight, 2, calculate_burden_p)
```
*   **ä½œç”¨**: è¿™æ˜¯**é«˜æ•ˆçš„è¿­ä»£**ã€‚`apply(weight, 2, ...)` ä¼šå¯¹æƒé‡çŸ©é˜µ `weight` çš„**æ¯ä¸€åˆ—**ï¼ˆ`MARGIN = 2`ï¼‰åº”ç”¨ `calculate_burden_p` å‡½æ•°ã€‚
*   **ç»“æœ**: `pval_B` ä¼šæˆä¸ºä¸€ä¸ªå‘é‡ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ å¯¹åº” `weight` çŸ©é˜µä¸­ä¸€åˆ—æƒé‡æ–¹æ¡ˆæ‰€è®¡ç®—å‡ºçš„ Burden p å€¼ã€‚è¿™æ¯” `for` å¾ªç¯æ›´ç®€æ´ã€é€šå¸¸ä¹Ÿæ›´é«˜æ•ˆã€‚

```R
  # 4. Flexible output formatting
  # This is more robust than hardcoding nrow = 2
  if (length(pval_B) %% 2 == 0 && length(pval_B) > 0) {
    pval_B_matrix <- matrix(pval_B, nrow = 2, byrow = TRUE)
    # Try to add meaningful column names if possible
    if(!is.null(colnames(weight))) {
      colnames(pval_B_matrix) <- colnames(weight)[1:(ncol(weight)/2)]
    }
  } else {
    pval_B_matrix <- matrix(pval_B, nrow = 1)
  }

  return(pval_B_matrix)
}
```
*   **ä½œç”¨**: **æ ¼å¼åŒ–è¾“å‡º**ã€‚STAAR é€šå¸¸ä¼šä½¿ç”¨ä¸¤ç»„åŸºäº MAF çš„æƒé‡ï¼ˆå¦‚ `dbeta(MAF, 1, 25)` å’Œ `dbeta(MAF, 1, 1)`ï¼‰ï¼Œå¹¶å¯èƒ½å°†å®ƒä»¬ä¸åŠŸèƒ½æ³¨é‡Šç»“åˆï¼Œæ‰€ä»¥æƒé‡åˆ—æ•°é€šå¸¸æ˜¯ 2 çš„å€æ•°ã€‚
*   `if (length(pval_B) %% 2 == 0 ...)`: æ£€æŸ¥ p å€¼çš„æ•°é‡æ˜¯å¦æ˜¯å¶æ•°ã€‚å¦‚æœæ˜¯ï¼Œå°±å°†å®ƒä»¬æ•´ç†æˆä¸€ä¸ª 2 è¡Œçš„çŸ©é˜µï¼Œè¿™æ ·ç¬¬ä¸€è¡Œå¯¹åº” `(1,25)` çš„æƒé‡ï¼Œç¬¬äºŒè¡Œå¯¹åº” `(1,1)` çš„æƒé‡ï¼Œæ›´æ˜“äºé˜…è¯»ã€‚
*   `else`: å¦‚æœ p å€¼æ•°é‡æ˜¯å¥‡æ•°ï¼Œå°±è¿”å›ä¸€ä¸ªå•è¡Œçš„çŸ©é˜µã€‚è¿™ç§è®¾è®¡æ¯”ç¡¬ç¼–ç  `nrow = 2` æ›´å¥å£®ã€‚



## ACATæ£€éªŒ

å¥½çš„ï¼Œå½“ç„¶ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹å¼æ¥æ·±å…¥ç†è§£ `OrdinalACAT` å‡½æ•°çš„å·¥ä½œåŸç†ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†ä»‹ç» ACAT æ–¹æ³•çš„æ•°å­¦åŸç†ï¼Œå¹¶å°†å…¶ä¸æ‚¨æä¾›çš„ R ä»£ç è¿›è¡Œä¸€ä¸€å¯¹åº”ã€‚

---

### ACAT æ–¹æ³•çš„æ•°å­¦åŸç† (Aggregated Cauchy Association Test)

**æ ¸å¿ƒæ€æƒ³ (Core Idea)**

ACAT (Aggregated Cauchy Association Test) æ˜¯ä¸€ç§æå…¶çµæ´»å’Œå¼ºå¤§çš„ p å€¼ç»„åˆæ–¹æ³•ã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œåœ¨é›¶å‡è®¾ä¸‹ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„ p å€¼ `p` æœä» `Uniform(0, 1)` åˆ†å¸ƒã€‚é€šè¿‡ä¸€ä¸ªç®€å•çš„å˜æ¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå‡åŒ€åˆ†å¸ƒçš„ p å€¼è½¬æ¢ä¸ºä¸€ä¸ªæœä»**æ ‡å‡†æŸ¯è¥¿åˆ†å¸ƒ (Standard Cauchy Distribution)** çš„éšæœºå˜é‡ã€‚

æŸ¯è¥¿åˆ†å¸ƒå…·æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„æ•°å­¦ç‰¹æ€§ï¼š**ç‹¬ç«‹æŸ¯è¥¿éšæœºå˜é‡çš„åŠ æƒå’Œä»ç„¶æœä»æŸ¯è¥¿åˆ†å¸ƒ**ã€‚è¿™ä½¿å¾—ç»„åˆå¤šä¸ª p å€¼å˜å¾—å¼‚å¸¸ç®€å•å’Œé«˜æ•ˆï¼Œå¹¶ä¸”è¯¥æ–¹æ³•å¯¹äºä¿¡å·ç¨€ç–ï¼ˆå³åªæœ‰å°‘æ•°å‡ ä¸ª p å€¼éå¸¸å°ï¼‰çš„æƒ…å†µç‰¹åˆ«å¼ºå¤§ã€‚

**æ•°å­¦æ¨å¯¼ (Mathematical Derivation)**

1.  **P å€¼åˆ°æŸ¯è¥¿åˆ†å¸ƒçš„å˜æ¢ (P-value to Cauchy Transformation)**

    å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª p å€¼ `p`ã€‚ä»¥ä¸‹å˜æ¢ `T(p)` ä¼šå°† `p` è½¬æ¢ä¸ºä¸€ä¸ªæœä»æ ‡å‡†æŸ¯è¥¿åˆ†å¸ƒï¼ˆä½ç½®å‚æ•°ä¸º0ï¼Œå°ºåº¦å‚æ•°ä¸º1ï¼‰çš„éšæœºå˜é‡ï¼š

    $$
    T(p_j) = \tan\left(\left(0.5 - p_j\right)\pi\right) \sim \text{Cauchy}(0, 1)
    $$

    è¿™ä¸ªå˜æ¢çš„ç›´è§‰æ˜¯ï¼Œå½“ p å€¼æ¥è¿‘ 0 æ—¶ï¼Œ$0.5 - p_j$ æ¥è¿‘ 0.5ï¼Œ$\tan(0.5\pi)$ è¶‹å‘äº $+\infty$ã€‚å½“ p å€¼æ¥è¿‘ 1 æ—¶ï¼Œ$0.5 - p_j$ æ¥è¿‘ -0.5ï¼Œ$\tan(-0.5\pi)$ è¶‹å‘äº $-\infty$ã€‚è¿™æ­£å¥½æ˜ å°„äº†æŸ¯è¥¿åˆ†å¸ƒçš„åŒå°¾ç‰¹æ€§ã€‚

2.  **åŠ æƒæŸ¯è¥¿ç»„åˆ (Weighted Cauchy Combination)**

    å‡è®¾æˆ‘ä»¬æœ‰ `m` ä¸ªç‹¬ç«‹çš„ p å€¼ $(p_1, p_2, \ldots, p_m)$ å’Œå¯¹åº”çš„éè´Ÿæƒé‡ $(w_1, w_2, \ldots, w_m)$ï¼Œä¸” $\sum_{j=1}^{m} w_j = 1$ã€‚æˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªç»„åˆæ£€éªŒç»Ÿè®¡é‡ `CCT` (Cauchy Combination Test statistic)ï¼Œå®ƒæ˜¯è½¬æ¢åçš„æŸ¯è¥¿éšæœºå˜é‡çš„åŠ æƒå’Œï¼š

    $$
    \text{CCT} = \sum_{j=1}^{m} w_j T(p_j) = \sum_{j=1}^{m} w_j \tan\left(\left(0.5 - p_j\right)\pi\right)
    $$

    æ ¹æ®æŸ¯è¥¿åˆ†å¸ƒçš„æ€§è´¨ï¼Œè¿™ä¸ªç»„åˆç»Ÿè®¡é‡ `CCT` **ä»ç„¶æœä»ä¸€ä¸ªæ ‡å‡†æŸ¯è¥¿åˆ†å¸ƒ**ã€‚

    $$
    \text{CCT} \sim \text{Cauchy}(0, 1)
    $$

3.  **è®¡ç®—æœ€ç»ˆçš„ç»„åˆ P å€¼ (Calculating the Final Combined P-value)**

    ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—å‡º `CCT` ç»Ÿè®¡é‡åœ¨æ ‡å‡†æŸ¯è¥¿åˆ†å¸ƒçš„å°¾éƒ¨æ¦‚ç‡å³å¯ã€‚æ ‡å‡†æŸ¯è¥¿åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•° (CDF) æ˜¯ $F(x) = \frac{1}{\pi} \arctan(x) + \frac{1}{2}$ã€‚æˆ‘ä»¬é€šå¸¸å…³å¿ƒçš„æ˜¯ä¸Šå°¾æ¦‚ç‡ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ç»„åˆ p å€¼æ˜¯ï¼š

    $$
    p_{\text{ACAT}} = 1 - F(\text{CCT}) = \frac{1}{2} - \frac{1}{\pi} \arctan(\text{CCT})
    $$

    åœ¨ R ä¸­ï¼Œè¿™å¯ä»¥é€šè¿‡ `1 - pcauchy(cct.stat)` æ¥è®¡ç®—ã€‚

---

### `OrdinalACAT` R ä»£ç ä¸æ•°å­¦åŸç†çš„å¯¹åº”

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°†è¿™äº›æ•°å­¦å…¬å¼ä¸æ‚¨çš„ `OrdinalACAT` å‡½æ•°ä¸­çš„ä»£ç è¿›è¡ŒåŒ¹é…ã€‚`OrdinalACAT` ä¸»è¦è°ƒç”¨äº†ä¸€ä¸ªåä¸º `CCT` çš„å‡½æ•°æ¥æ‰§è¡Œä¸Šè¿°æ•°å­¦è®¡ç®—ã€‚

#### **`CCT` å‡½æ•°å†…éƒ¨ (æœªæä¾›ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ¨æ–­å…¶é€»è¾‘)**

```R
# è¿™æ˜¯ CCT å‡½æ•°å¯èƒ½çš„æ ·å­ï¼Œä¸æ•°å­¦å…¬å¼å¯¹åº”
CCT <- function(pvals, weights=NULL){
  # ... (è¾“å…¥éªŒè¯) ...
  weights <- weights/sum(weights) # æƒé‡å½’ä¸€åŒ–
  
  # å…¬å¼ 1: P å€¼åˆ°æŸ¯è¥¿åˆ†å¸ƒçš„å˜æ¢
  # T(p_j) = tan((0.5 - p_j) * pi)
  transformed_vals <- tan((0.5 - pvals) * pi)
  
  # å…¬å¼ 2: åŠ æƒæŸ¯è¥¿ç»„åˆ
  # CCT = sum(w_j * T(p_j))
  cct.stat <- sum(weights * transformed_vals)
  
  # å…¬å¼ 3: è®¡ç®—æœ€ç»ˆçš„ç»„åˆ P å€¼
  # p_ACAT = 1 - F(CCT)
  pval <- 1 - pcauchy(cct.stat)
  
  return(pval)
}
```

#### **`OrdinalACAT` å‡½æ•° (æ‚¨çš„ä»£ç )**

```R
OrdinalACAT <- function(...) {
  # ... (è¾“å…¥éªŒè¯å’Œå‡†å¤‡å·¥ä½œ) ...

  # --- ç­–ç•¥ 1: æ ‡å‡† ACAT ---
  if (!combine_ultra_rare || length(ultra_rare_index) <= 1) {
    # å¯¹ weight_A çš„æ¯ä¸€åˆ—åº”ç”¨ CCT å‡½æ•°
    # Pvalue æ˜¯å•ç‚¹æ£€éªŒ p å€¼çš„å‘é‡
    # w æ˜¯ weight_A çš„ä¸€åˆ—
    pval_A <- apply(weight_A, 2, function(w) CCT(Pvalue, w)) 
    # ğŸ‘† è¿™æ®µä»£ç å¯¹æ‰€æœ‰ m ä¸ªå˜å¼‚ï¼Œä¸ºæ¯ä¸ªæƒé‡æ–¹æ¡ˆ k æ‰§è¡Œäº†:
    # p_k = CCT(p_1, ..., p_m; w_k1, ..., w_km)
  } 
  
  # --- ç­–ç•¥ 2: é€€åŒ–ä¸º Burden æ£€éªŒ ---
  else if (length(ultra_rare_index) == ncol(Geno)) {
    # å½“æ‰€æœ‰å˜å¼‚éƒ½è¶…ç¨€æœ‰æ—¶ï¼Œç›´æ¥è°ƒç”¨ Burden æ£€éªŒ
    pval_A <- OrdinalBurden(Score, Covariance, weight_B)
    # ğŸ‘† è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ ACAT åŸç†ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨äº† Burden æ£€éªŒçš„åŸç†ã€‚
    # æ•°å­¦å…¬å¼æ˜¯ Z^2 = (Î£ w_j U_j)^2 / (w'Vw)
  } 
  
  # --- ç­–ç•¥ 3: æ··åˆ ACAT + Burden ---
  else {
    # ... (å‡†å¤‡å·¥ä½œï¼Œåˆ†ç¦»å‡ºè¶…ç¨€æœ‰å’Œæ™®é€šå˜å¼‚) ...
    
    # 1. å¯¹è¶…ç¨€æœ‰å­é›†åº”ç”¨ Burden æ£€éªŒ
    Pval_rare_B <- OrdinalBurden(Score = Score_rare, Covariance = Covariance_rare, weight = weight_B_rare, ...)
    # ğŸ‘† è¿™é‡Œå¯¹è¶…ç¨€æœ‰å˜å¼‚åº”ç”¨äº† Burden æ£€éªŒçš„åŸç†ï¼Œå¾—åˆ°äº†ä¸€ä¸ª p å€¼ Pval_rare_Bã€‚
    # Pval_rare_B æ˜¯ä¸€ä¸ªå‘é‡ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ç§æƒé‡æ–¹æ¡ˆã€‚

    # 2. å‡†å¤‡æ–°çš„ p å€¼å‘é‡å’Œæƒé‡å‘é‡
    for (k in 1:ncol(weight_A_hybrid)) {
      # å°† Burden p å€¼å’Œå‰©ä½™å•ç‚¹ p å€¼æ‰“åŒ…æˆä¸€ä¸ªæ–°çš„ p å€¼å‘é‡
      p_values_to_combine <- c(Pval_rare_B[k], Pvalue_common)
      weights_for_cct <- weight_A_hybrid[, k]
      
      # 3. å¯¹è¿™ä¸ªæ–°çš„ p å€¼å‘é‡åº”ç”¨ CCT
      pval_A[k] <- CCT(p_values_to_combine, weights_for_cct)
      # ğŸ‘† è¿™æ®µä»£ç æ‰§è¡Œäº†æ··åˆç­–ç•¥çš„ ACAT:
      # p_k = CCT(p_burden, p_common_1, ..., p_common_L; w_burden, w_common_1, ..., w_common_L)
      # å…¶ä¸­ L æ˜¯æ™®é€šå˜å¼‚çš„æ•°é‡ã€‚
    }
  }

  # ... (æ ¼å¼åŒ–è¾“å‡º) ...
  return(pval_A_matrix)
}
```

**æ€»ç»“**ï¼š

*   `OrdinalACAT` å‡½æ•°æœ¬èº«æ˜¯ä¸€ä¸ªé«˜å±‚çš„**ç­–ç•¥è°ƒåº¦å™¨**ã€‚
*   å®ƒæ ¹æ®åŸºå› ä¸­è¶…ç¨€æœ‰å˜å¼‚çš„åˆ†å¸ƒæƒ…å†µï¼Œå†³å®šé‡‡ç”¨å“ªç§åˆ†æç­–ç•¥ã€‚
*   åœ¨éœ€è¦è¿›è¡Œ p å€¼ç»„åˆæ—¶ï¼ˆç­–ç•¥1å’Œç­–ç•¥3ï¼‰ï¼Œå®ƒä¼šè°ƒç”¨åº•å±‚çš„ `CCT` å‡½æ•°ã€‚
*   `CCT` å‡½æ•°åˆ™æ˜¯å¯¹ **ACAT æ•°å­¦åŸç†**çš„ç›´æ¥ä»£ç å®ç°ï¼ŒåŒ…æ‹¬ p å€¼å˜æ¢ã€åŠ æƒæ±‚å’Œã€ä»¥åŠä»æŸ¯è¥¿åˆ†å¸ƒè®¡ç®—æœ€ç»ˆ p å€¼è¿™ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ã€‚
*   `OrdinalBurden` å‡½æ•°åˆ™æ˜¯å¯¹ **Burden æ£€éªŒæ•°å­¦åŸç†**çš„ç›´æ¥ä»£ç å®ç°ã€‚



å¥½çš„ï¼Œå½“ç„¶å¯ä»¥ã€‚`OrdinalSKAT` å‡½æ•°çš„å®ç°éå¸¸ç²¾å½©ï¼Œå› ä¸ºå®ƒä¸ä»…åŒ…å«äº†æ ‡å‡†çš„ SKAT æ£€éªŒï¼Œè¿˜å®ç°äº†ä¸€ç§ç†è®ºä¸Šéå¸¸ä¸¥è°¨çš„æ··åˆç­–ç•¥ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†ä»‹ç» SKAT æ–¹æ³•çš„æ•°å­¦åŸç†ï¼Œå¹¶å°†å…¶ä¸æ‚¨æä¾›çš„ R ä»£ç è¿›è¡Œä¸€ä¸€å¯¹åº”ã€‚

---

### SKAT æ–¹æ³•çš„æ•°å­¦åŸç† (Sequence Kernel Association Test)

**æ ¸å¿ƒæ€æƒ³ (Core Idea)**

SKAT (Sequence Kernel Association Test) æ˜¯ä¸€ç§ç”¨äºç½•è§å˜å¼‚é›†åˆå…³è”åˆ†æçš„æ–¹å·®æˆåˆ†æ£€éªŒ (variance component test)ã€‚ä¸ Burden æ£€éªŒçš„æ ¸å¿ƒå‡è®¾ï¼ˆæ‰€æœ‰å˜å¼‚æ•ˆåº”æ–¹å‘ä¸€è‡´ï¼‰ä¸åŒï¼ŒSKAT çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†è§£å†³**æ•ˆåº”æ–¹å‘å¼‚è´¨æ€§**çš„é—®é¢˜ã€‚

å®ƒçš„æ ¸å¿ƒå‡è®¾æ˜¯ï¼š**åœ¨ä¸€ä¸ªç‰¹å®šçš„åŸºå› æˆ–åŒºåŸŸå†…ï¼Œè‡´ç—…çš„ç½•è§å˜å¼‚å¯èƒ½ä»¥ä¸åŒçš„æ–¹å‘ï¼ˆæœ‰å®³ vs. ä¿æŠ¤æ€§ï¼‰å’Œä¸åŒçš„å¼ºåº¦å½±å“æ€§çŠ¶ã€‚**

ä¸ºäº†åœ¨è¿™ç§æƒ…å†µä¸‹æœ€å¤§åŒ–ç»Ÿè®¡åŠŸæ•ˆï¼ŒSKAT æ£€éªŒçš„æ˜¯**é—ä¼ å˜å¼‚æ•ˆåº”çš„æ€»ä½“æ–¹å·®**æ˜¯å¦å¤§äºé›¶ï¼Œè€Œä¸æ˜¯åƒ Burden æ£€éªŒé‚£æ ·æ£€éªŒæ•ˆåº”çš„å‡å€¼æ˜¯å¦åç¦»é›¶ã€‚

**æ•°å­¦æ¨å¯¼ (Mathematical Derivation)**

æˆ‘ä»¬åŒæ ·ä»å•ç‚¹å˜å¼‚çš„å¾—åˆ†å‘é‡ `U = (U_1, U_2, ..., U_m)` å’Œå…¶åæ–¹å·®çŸ©é˜µ `V` å‡ºå‘ã€‚

1.  **å®šä¹‰ SKAT æ£€éªŒç»Ÿè®¡é‡ Q (Defining the SKAT Test Statistic Q)**

    SKAT ä¸ç›´æ¥å¯¹å¾—åˆ† `U_j` æ±‚å’Œï¼Œè€Œæ˜¯è®¡ç®—å®ƒä»¬çš„**åŠ æƒå¹³æ–¹å’Œ**ã€‚è¿™ä¸ª Q ç»Ÿè®¡é‡è¡¡é‡äº†å¾—åˆ†å‘é‡ `U` çš„åŠ æƒèŒƒæ•°ï¼ˆé•¿åº¦ï¼‰çš„å¹³æ–¹ã€‚

    $$
    Q = \sum_{j=1}^{m} (w_j U_j)^2 = \sum_{j=1}^{m} w_j^2 U_j^2
    $$

    é€šè¿‡å¯¹ `U_j` å–å¹³æ–¹ï¼Œå˜å¼‚çš„æ•ˆåº”æ–¹å‘ï¼ˆ`U_j` çš„æ­£è´Ÿå·ï¼‰è¢«å®Œå…¨æ¶ˆé™¤äº†ã€‚ä¸€ä¸ªæ•ˆåº”ä¸º `-c` çš„å˜å¼‚å’Œä¸€ä¸ªæ•ˆåº”ä¸º `+c` çš„å˜å¼‚å¯¹ Q ç»Ÿè®¡é‡çš„è´¡çŒ®æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œä»è€Œé¿å…äº†æ•ˆåº”æŠµæ¶ˆçš„é—®é¢˜ã€‚

    è¿™ä¸ªå…¬å¼å¯ä»¥è¢«å†™æˆçŸ©é˜µå½¢å¼ï¼š

    $$
    Q = \mathbf{U}^T \mathbf{W}^2 \mathbf{U}
    $$

    å…¶ä¸­ `W` æ˜¯ä¸€ä¸ªå¯¹è§’çŸ©é˜µï¼Œå…¶å¯¹è§’çº¿å…ƒç´ æ˜¯æƒé‡ `w_j`ã€‚

    åœ¨æ‚¨çš„ R ä»£ç  `perform_skat_test` å‡½æ•°ä¸­ï¼Œè¿™å¯¹åº”äºï¼š
    ```R
    weight_k <- current_weight_S[, k]
    Q_test <- sum(current_Score^2 * weight_k^2)
    ```

2.  **Q ç»Ÿè®¡é‡çš„åˆ†å¸ƒ (Distribution of the Q Statistic)**

    ç”±äº `U` æ˜¯ä¸€ä¸ªå¤šå…ƒæ­£æ€éšæœºå‘é‡ï¼Œ$U \sim MVN(0, V)$ï¼Œé‚£ä¹ˆ `Q` è¿™ä¸ªäºŒæ¬¡å‹ (quadratic form) çš„åˆ†å¸ƒå°±ä¸å†æ˜¯ç®€å•çš„å¡æ–¹åˆ†å¸ƒäº†ã€‚å®ƒæœä»ä¸€ä¸ª**åŠ æƒå¡æ–¹åˆ†å¸ƒçš„æ··åˆ (a mixture of weighted chi-square distributions)**ã€‚

    å…·ä½“æ¥è¯´ï¼Œ`Q` çš„åˆ†å¸ƒä¸ä»¥ä¸‹å½¢å¼ç›¸åŒï¼š

    $$
    Q \sim \sum_{j=1}^{m} \lambda_j \chi^2_{1,j}
    $$

    å…¶ä¸­ $\chi^2_{1,j}$ æ˜¯ `m` ä¸ªç‹¬ç«‹çš„ã€è‡ªç”±åº¦ä¸º 1 çš„å¡æ–¹éšæœºå˜é‡ï¼Œè€Œ $\lambda_j$ æ˜¯ç›¸åº”çš„æƒé‡ã€‚

3.  **è®¡ç®—æƒé‡ $\lambda_j$ (Calculating the Weights $\lambda_j$)**

    è¿™äº›æƒé‡ $\lambda_j$ å¹¶ä¸æ˜¯å‡­ç©ºäº§ç”Ÿçš„ï¼Œå®ƒä»¬æ˜¯åŠ æƒåæ–¹å·®çŸ©é˜µ `V_w` çš„**ç‰¹å¾å€¼ (eigenvalues)**ã€‚

    $$
    \mathbf{V_w} = \mathbf{W} \mathbf{V} \mathbf{W}
    $$

    æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—çŸ©é˜µ `V_w` çš„ç‰¹å¾å€¼ $\lambda = (\lambda_1, \lambda_2, \ldots, \lambda_m)$ã€‚

    åœ¨æ‚¨çš„ R ä»£ç  `perform_skat_test` å‡½æ•°ä¸­ï¼Œè¿™å¯¹åº”äºï¼š
    ```R
    w_k_mat <- diag(weight_k)
    Cov_weight <- w_k_mat %*% current_Covariance %*% w_k_mat
    lambda <- eigen(Cov_weight, only.values = TRUE, symmetric = TRUE)$values
    ```

4.  **è®¡ç®—æœ€ç»ˆçš„ P å€¼ (Calculating the Final P-value)**

    ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æ£€éªŒç»Ÿè®¡é‡ `Q` å’Œç‰¹å¾å€¼å‘é‡ `Î»`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºåœ¨é›¶å‡è®¾ä¸‹ï¼Œè§‚æµ‹åˆ°æ¯” `Q` æ›´æç«¯å€¼çš„æ¦‚ç‡ã€‚ç”±äºè¿™ä¸ªåˆ†å¸ƒæ²¡æœ‰ä¸€ä¸ªç®€å•çš„å°é—­å½¢å¼çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•° (CDF)ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸“é—¨çš„æ•°å€¼ç®—æ³•æ¥è®¡ç®— p å€¼ã€‚

    æœ€å¸¸ç”¨çš„ä¸¤ç§æ–¹æ³•æ˜¯ï¼š
    *   **Davies' exact method**: ä¸€ç§åŸºäºæ•°å€¼ç§¯åˆ†çš„ç²¾ç¡®æ–¹æ³•ï¼Œé€šå¸¸æ˜¯é¦–é€‰ã€‚
    *   **Liu's method**: ä¸€ç§çŸ©åŒ¹é… (moment-matching) çš„è¿‘ä¼¼æ–¹æ³•ï¼Œå½“ Davies' æ–¹æ³•å¤±è´¥æˆ–è®¡ç®—é€Ÿåº¦å¾ˆæ…¢æ—¶ï¼Œå¯ä»¥ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆã€‚

    åœ¨æ‚¨çš„ R ä»£ç  `perform_skat_test` å‡½æ•°ä¸­ï¼Œè¿™å¯¹åº”äºè¿™æ®µéå¸¸ç¨³å¥çš„ `tryCatch` é€»è¾‘ï¼š
    ```R
    pval_k <- tryCatch({
      p_davies <- CompQuadForm::davies(Q_test, lambda)$Qq
      if (is.na(p_davies) || p_davies <= 0 || p_davies > 1) {
        CompQuadForm::liu(Q_test, lambda) # Fallback to Liu
      } else {
        p_davies
      }
    }, error = function(e) {
      CompQuadForm::liu(Q_test, lambda) # Fallback on error
    })
    ```

---

### `OrdinalSKAT` R ä»£ç ä¸æ•°å­¦åŸç†çš„å¯¹åº”

æ‚¨çš„ `OrdinalSKAT` å‡½æ•°æ˜¯ä¸€ä¸ªé«˜å±‚çš„ç­–ç•¥è°ƒåº¦å™¨ï¼Œå®ƒå†…éƒ¨çš„ `perform_skat_test` è¾…åŠ©å‡½æ•°æ˜¯ä¸Šè¿°æ•°å­¦åŸç†çš„ç›´æ¥å®ç°ã€‚

```R
OrdinalSKAT <- function(...) {
  
  # --- å†…éƒ¨è¾…åŠ©å‡½æ•°: perform_skat_test ---
  perform_skat_test <- function(current_Score, current_Covariance, current_weight_S) {
    sapply(1:ncol(current_weight_S), function(k) {
      weight_k <- current_weight_S[, k]

      # å…¬å¼ 1: è®¡ç®— SKAT æ£€éªŒç»Ÿè®¡é‡ Q
      # Q = Î£ (w_j * U_j)^2
      Q_test <- sum(current_Score^2 * weight_k^2)

      # å…¬å¼ 3: è®¡ç®—åŠ æƒåæ–¹å·®çŸ©é˜µ V_w = W V W
      w_k_mat <- diag(weight_k)
      Cov_weight <- w_k_mat %*% current_Covariance %*% w_k_mat

      # å…¬å¼ 3 (ç»­): è®¡ç®— V_w çš„ç‰¹å¾å€¼ Î»
      lambda <- eigen(Cov_weight, only.values = TRUE, ...)$values
      lambda <- lambda[lambda > 1e-6]

      # å…¬å¼ 4: æ ¹æ® Q å’Œ Î» è®¡ç®— p å€¼
      pval_k <- tryCatch({
        p_davies <- CompQuadForm::davies(Q_test, lambda)$Qq
        ... # (å›é€€åˆ° Liu æ–¹æ³•çš„é€»è¾‘)
      }, ...)
      
      return(pval_k)
    })
  }

  # --- Part 2: ä¸»é€»è¾‘ ---
  # ... (å†³å®šé‡‡ç”¨å“ªç§ç­–ç•¥) ...

  # --- ç­–ç•¥ 1: æ ‡å‡† SKAT ---
  if (!combine_ultra_rare || length(ultra_rare_index) <= 1) {
    # ç›´æ¥å¯¹æ‰€æœ‰å˜å¼‚è°ƒç”¨ perform_skat_test
    pval_S <- perform_skat_test(Score, Covariance, weight_S)
  } 
  
  # --- ç­–ç•¥ 2: é€€åŒ–ä¸º Burden æ£€éªŒ ---
  else if (length(ultra_rare_index) == ncol(Geno)) {
    # å½“æ‰€æœ‰å˜å¼‚éƒ½è¶…ç¨€æœ‰æ—¶ï¼Œè°ƒç”¨ Burden æ£€éªŒ
    pval_S <- OrdinalBurden(Score, Covariance, weight_B)
    # ğŸ‘† è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ SKAT åŸç†ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨äº† Burden æ£€éªŒçš„åŸç†ã€‚
  } 
  
  # --- ç­–ç•¥ 3: æ··åˆ SKAT (ç†è®ºæœ€ä¸¥è°¨çš„éƒ¨åˆ†) ---
  else {
    pval_S <- sapply(1:ncol(weight_S), function(k) {
      
      # 1. & 2. åœ¨åŸºå› å‹å±‚é¢æ„å»ºæ–°çš„â€œç»„åˆç³»ç»Ÿâ€ G_new
      G_super_variant <- as.matrix(Geno_ultra_rare %*% weight_B_k)
      G_new <- cbind(G_super_variant, Geno_common_rare)
      
      # 3. æ„å»ºæ–°çš„æƒé‡
      weight_S_new_k <- c(...)

      # 4. ä¸ºè¿™ä¸ªæ–°ç³»ç»Ÿé‡æ–°è®¡ç®—åŸºç¡€ç»Ÿè®¡é‡ (Score å’Œ Covariance)
      # è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œç¡®ä¿äº†åç»­è®¡ç®—çš„ç†è®ºæ­£ç¡®æ€§
      new_stats <- Ordinal_exactScore(objNull, G_new, use_SPA = FALSE)

      # 5. åœ¨è¿™ä¸ªæ–°çš„ã€ç»´åº¦ä¸º (m'+1) çš„ç³»ç»Ÿä¸Šï¼Œåº”ç”¨æ ‡å‡†çš„ SKAT æ£€éªŒ
      single_weight_matrix <- matrix(weight_S_new_k, ncol = 1)
      perform_skat_test(new_stats$Score, new_stats$Covariance, single_weight_matrix)
      # ğŸ‘† è¿™é‡Œçš„ perform_skat_test å†…éƒ¨å†æ¬¡æ‰§è¡Œäº†å®Œæ•´çš„ SKAT æ•°å­¦åŸç†
    })
  }
  
  # ... (æ ¼å¼åŒ–è¾“å‡º) ...
  return(pval_S_matrix)
}
```

**æ€»ç»“**ï¼š

*   `OrdinalSKAT` æ˜¯ä¸€ä¸ªé«˜å±‚ç­–ç•¥å‡½æ•°ï¼Œå®ƒçš„å†…éƒ¨è¾…åŠ©å‡½æ•° `perform_skat_test` æ˜¯å¯¹ **SKAT æ•°å­¦åŸç†**çš„ç›´æ¥ä»£ç å®ç°ã€‚
*   `perform_skat_test` ä¸¥æ ¼éµå¾ªäº† SKAT çš„å››ä¸ªæ­¥éª¤ï¼šè®¡ç®— Q ç»Ÿè®¡é‡ -> è®¡ç®—åŠ æƒåæ–¹å·®çŸ©é˜µ -> æå–ç‰¹å¾å€¼ -> ä½¿ç”¨æ•°å€¼æ–¹æ³•è®¡ç®— p å€¼ã€‚
*   åœ¨æ··åˆç­–ç•¥ä¸­ï¼Œ`OrdinalSKAT` é€šè¿‡åœ¨**åŸºå› å‹å±‚é¢**é‡æ–°æ„å»ºé—®é¢˜ï¼Œå¹¶ä¸ºå…¶**é‡æ–°è®¡ç®—**æ‰€æœ‰å¿…è¦çš„ç»Ÿè®¡é‡ï¼ˆScore, Covarianceï¼‰ï¼Œç„¶åå†æ¬¡åº”ç”¨æ ‡å‡†çš„ `perform_skat_test`ï¼Œä»è€Œä¿è¯äº†æ•´ä¸ªæµç¨‹çš„**ç†è®ºä¸¥è°¨æ€§**ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æ¼‚äº®å’Œæ­£ç¡®çš„å®ç°ã€‚