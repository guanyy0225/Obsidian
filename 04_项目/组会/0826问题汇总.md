# REGENIE不要用PCA？

# 权重为0的样本多不多？
好的，这次的输出信息非常非常重要，它揭示了一个**严重的问题**。

让我们来解读这个输出，特别是那个惊人的百分比。

### 诊断信息解读

```
警告信息:
1: Numerical instability detected in weight calculation.
  - 137565 out of 484058 samples (28.4191%) had near-zero variance for latent residuals.
  - ...
```

*   **核心发现**: 在你的48万样本中，有高达**13.7万**个样本（占总数的 **28.4%**）的潜在残差方差（`var_y`）计算结果为负数或接近于零。
*   **问题严重性**: **这非常严重**。这不是少数极端值导致的数值噪音，而是一个系统性的问题。百分比如此之高，意味着你的零模型**极度不稳定**，并且很可能是**错误的**。
*   **警告的提示**: 警告中说 `If the percentage is high, consider checking for covariate separation.` (如果百分比很高，请考虑检查协变量分离)。我们的百分比非常高，所以这正是我们需要做的事情。

### 根本原因：准完美分离 (Quasi-Complete Separation)

**28.4%** 这个数字几乎可以肯定地指向了**准完美分离**。

*   **什么是准完美分离?**
    在你的模型中，一个或多个协变量（或者它们的线性组合）能够**几乎完美地**预测出有序表型的结果。
    例如，可能存在这样的情况：
    *   当 `prs_pc1` 的值小于 `-2` 时，**100%** 的样本都是 "Never" 或 "Special occasions only"。
    *   当 `prs_pc1` 的值大于 `3` 时，**100%** 的样本都是 "Daily or almost daily"。
    *   （这里的 `prs_pc1` 和阈值只是举例）

*   **为什么这会导致模型崩溃?**
    1.  **系数估计趋向无穷大**: 为了拟合这种“完美”的预测关系，`ordinal::clm` 算法会尝试将与该协变量相关的系数（`beta`）推向正无穷或负无穷。
    2.  **线性预测器 `eta` 变得极端**: 由于系数被推向无穷大，很多样本的线性预测器 `eta` (`Xβ`) 也会变得非常大或非常小。
    3.  **概率计算崩溃**: 当 `eta` 值极端时，计算概率（`pnorm`）和密度（`dnorm`）的函数会因为浮点数精度限制而返回不准确的0或1，导致我们之前讨论的`var_y`计算崩溃（结果为负数或零）。
    4.  **结果不可信**: 一个发生了分离的模型，其系数、标准误和p值都是不可靠的。因此，基于这个模型构建的零模型也是不可靠的，后续的关联分析结果将毫无意义。

### 罪魁祸首是谁？

在你的模型 `alcohol_intake_frequency ~ sex + age + age2 + PC1-10 + prs_pc1-5` 中，最有可能导致分离的变量是 **`prs_pc1` 到 `prs_pc5`**。

为什么？因为这些PRS主成分是你通过REGENIE的多性状方法，专门为了**最大化预测酒精摄入频率**而构建的。它们本身就是非常强大的预测因子。如果它们中的某一个（或某几个的组合）过于强大，就很容易导致分离。

### 下一步行动：诊断和解决

现在我们的首要任务是**确认分离的存在**并**解决它**。不能再继续使用这个零模型了。

#### 步骤1：可视化诊断

画图是确认分离最直观的方法。请在你拟合模型的数据 `data_for_null_model` 上运行以下代码：

```R
library(ggplot2)

# 检查每个PRS-PC与有序表型的关系
# 我们以 prs_pc1 为例，你应该对所有的prs_pc都画一遍
ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = prs_pc1, fill = alcohol_intake_frequency)) +
  geom_boxplot() +
  labs(
    title = "Boxplot of PRS_PC1 by Alcohol Intake Frequency",
    x = "Alcohol Intake Frequency",
    y = "PRS Principal Component 1"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 对 prs_pc2, prs_pc3 等重复此操作
ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = prs_pc2, fill = alcohol_intake_frequency)) +
  geom_boxplot() # ... etc.
```

**你要在图中寻找什么？**
寻找一个**清晰的分界线**。例如，如果你发现 "Never" 类别的箱线图的整个范围（包括触须）都低于 "Daily" 类别的箱线图的整个范围，没有任何重叠，那么就存在完美分离。即使只有部分类别存在这种清晰的分界，也足以导致准完美分离。

#### 步骤2：解决方案

如果确认了分离，你有几个选项，严重程度递增：

1.  **方案A (首选): 使用带有惩罚的回归模型**
    `ordinal::clm` 本身不直接支持惩罚回归。但是，我们可以换一个能够处理分离问题的模型。最常用的是**Firth's Penalized Likelihood**。
    *   **挑战**: 将Firth回归的结果转换为STAAR/GENESIS兼容的零模型需要做大量的自定义开发，非常复杂。

2.  **方案B (次选，但更实用): 调整PRS主成分**
    *   **减少PRS-PC的数量**: 分离很可能是由最主要的那个PRS-PC（通常是`prs_pc1`）引起的。尝试在你的零模型`formula`中**移除`prs_pc1`**，只使用`prs_pc2`到`prs_pc5`，然后重新拟合，看看28%的比例是否会大幅下降。
        ```R
        # 调整公式
        regenie_covars_adjusted <- paste0("prs_pc", 2:5, collapse = " + ")
        null_model_formula_adjusted <- as.formula(paste("alcohol_intake_frequency ~", base_covars, "+", regenie_covars_adjusted))
        
        # 重新运行你的函数
        obj <- fit_NullModel_ordinal_robust(formula = null_model_formula_adjusted, ...)
        ```
    *   如果只去掉`prs_pc1`还不够，可以尝试只用`prs_pc3`到`prs_pc5`，以此类推。目标是在**保持足够预测能力**和**避免模型分离**之间找到一个平衡。

3.  **方案C (最后的手段): 二分化表型**
    如果无论如何调整都存在分离，这可能说明这个有序表型的遗传结构本质上就非常“极端”。你可以考虑将问题简化，例如，将6个类别合并为2个或3个，然后使用标准的方法（如逻辑斯蒂回归）进行分析。但这会损失信息。

**我强烈建议你从步骤1（可视化）开始，然后尝试步骤2（调整PRS-PC）。28.4%这个数字明确告诉你，当前的零模型是不可用的，必须进行修正。**



您完全正确，我之前的判断是错误的。

我向您道歉。您刚刚提供的这个结果，是解决这个问题的**最关键的一块拼图**。

您通过这个实验，完美地证明了一件事：**问题的根源不在 `regenie_covars`，而是在 `base_covars` 内部！**

让我们来重新梳理一下逻辑，因为我们现在已经非常接近真相了。

### 为什么说我们之前的判断是错误的？

*   **旧的假设**: 我们一直假设，导致28.4%样本计算不稳定的原因是 `prs_pc1` 到 `prs_pc5` 的预测能力太强。
*   **您的实验**: 您运行了一个**完全不包含 `prs_pc`**，只包含 `base_covars` 和一个随机噪音项的模型。
*   **惊人的结果**: 这个模型产生了**一模一样**的错误，相同的样本数，相同的百分比。

**这个结果无可辩驳地证明了，导致准完美分离的那个“罪魁祸首”变量，一直隐藏在 `base_covars` 内部。** `prs_pc` 从来都不是问题的根源。

### 新的、更准确的假设：问题出在基因主成分（PCs）上

`base_covars` 包含 `sex`, `age`, `age2`, 以及 **`PC1` 到 `PC10`**。

*   `sex`, `age`, `age2` 不太可能在几十万人的数据中造成如此大规模的分离。
*   **因此，最有可能的罪魁祸首，就是 `PC1` 到 `PC10` 中的某一个或某几个。**

**为什么基因主成分（PCs）会导致分离？**
基因主成分（PCs）代表了个体的**遗传祖源 (Genetic Ancestry)**。众所周知，不同的祖源人群在生活习惯、文化以及酒精代谢能力（例如，乙醛脱氢酶基因的差异）上存在显著差异。

因此，一个非常 plausible 的新假设是：
**你的数据集中，某个主要的基因主成分（很可能是`PC1`或`PC2`）与酒精摄入频率这个行为表型高度相关，以至于造成了准完美分离。** 例如，某个祖源群体（由`PC1`的值反映）的成员绝大多数都是“从不”饮酒者，而另一个祖源群体的成员则广泛分布在其他饮酒类别中。

这个效应是如此之强，以至于无论你是否加入`prs_pc`，它都主导着模型的拟合过程，并导致了完全相同的28.4%的样本出现数值计算崩溃。

---

### 最重要的下一步：验证新假设

现在我们的目标非常明确：**找出 `base_covars` 中导致分离的元凶。**

请您运行和我们之前检查`prs_pc1`时完全一样的可视化诊断代码，但这次的目标是 **`PC1`**。

#### 请立即运行这段代码：

```R
library(ggplot2)

# >> 关键诊断步骤：检查 PC1 与表型的关系 <<

ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = PC1, fill = alcohol_intake_frequency)) +
  geom_boxplot() +
  labs(
    title = "Boxplot of Genetic PC1 by Alcohol Intake Frequency",
    x = "Alcohol Intake Frequency",
    y = "Genetic Principal Component 1 (PC1)"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 如果 PC1 看不出问题，请继续检查 PC2
ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = PC2, fill = alcohol_intake_frequency)) +
  geom_boxplot() # ... etc.
```

**您要在图中寻找什么？**
寻找和之前`prs_pc1`那张图类似的**强烈趋势**。我预测您会看到，随着饮酒频率的变化，`PC1`（或`PC2`）的分布会出现一个非常清晰的、单调的上升或下降趋势，甚至可能在某些类别之间出现比`prs_pc1`更明显的分界。

### 如果新假设被证实，如何解决？

一旦我们从图中确认了是某个PC（比如`PC1`）导致的问题，解决方案就变得清晰了：

1.  **最佳方案 (统计学上最严谨): 分层分析 (Stratified Analysis)**
    如果`PC1`清晰地分开了不同的祖源人群，最严谨的做法是按人群进行分层分析。例如，只在欧洲人群（可能由`PC1`的某个范围定义）内部进行一次完整的关联分析，然后在其他人群中再进行一次。这可以避免由群体差异带来的混杂。但这会增加工作量。

2.  **次选方案 (更直接的修复): 从模型中移除有问题的PC**
    这是一个更直接的解决方法。既然`PC1`是问题所在，我们就将它从零模型中移除。**注意：** 这样做有一个风险，就是可能无法完全校正群体结构，可能会在后续关联分析中引入一些假阳性。但在模型无法拟合的情况下，这是一个必要的妥协。

    ```R
    # >> 修复代码 <<
    # 从 base_covars 中移除 PC1
    base_covars_adjusted <- "sex + age + age2 + PC2 + PC3 + PC4 + PC5 + PC6 + PC7 + PC8 + PC9 + PC10"
    
    # 在你的公式中，可以重新加入所有5个prs_pc，因为它们不是问题所在
    regenie_covars_full <- paste0("prs_pc", 1:5, collapse = " + ")
    
    null_model_formula_final <- as.formula(paste("alcohol_intake_frequency ~", base_covars_adjusted, "+", regenie_covars_full))
    
    # 重新运行模型
    obj_final <- fit_NullModel_ordinal_robust(
      formula = null_model_formula_final,
      data = data_for_null_model,
      # ... 其他参数
    )
    ```

**总结：**
您之前的实验结果非常关键，它将我们的注意力从`prs_pc`成功地转移到了`base_covars`中的基因主成分上。

**我强力推荐您立即执行上面的可视化诊断代码，检查`PC1`和`PC2`的箱线图。** 我非常有信心，您将在其中找到导致这个顽固问题的根本原因。

# 选出的样本为0？

# 查看其他的有序多分类是否用的是比例优势模型

# SPA的问题