好的，我们来对 "Score test and estimated variance" 这一节进行一次最详细、最忠实于原文符号的解读。

这一部分的核心目标是推导出一个在统计上有效且计算上高效的检验统计量，用于检验在空模型（H₀: γ=0）下，每个遗传变异 `G` 与序数表型 `y` 的关联性。

---

### 1. 得分统计量 (Score Statistic `T`)

得分统计量 `T` 是在空假设（γ=0）下，边缘对数似然函数 `l(β, τ; ε)` 关于遗传效应参数 `γ` 的一阶偏导数。根据附录B的推导，其表达式为：

`T = ∂l(β, τ; ε) / ∂γ |_(γ=0) = G̃^T Ž^T R(ỹ - μ̂) = G̃^T Ž^T RWR(Y - η̂) = G̃^T Ž^T P̃Ỹ`

这里的符号分解如下：

*   `G̃`: 这是一个 `n x 1` 的向量，代表**经过协变量调整后的基因型**。其计算公式为 `G̃ = G - X(X^T Ž^T RWRŽX)^-1 X^T Ž^T RWRŽG`。它表示基因型 `G` 中不能被协变量 `X` 线性解释的部分。
*   `Ž`: 这是一个 `n(J-1) x n` 的矩阵，用于将样本水平的效应扩展到类别水平。
*   `R`: 这是一个 `n(J-1) x n(J-1)` 的对角矩阵，其元素 `R_ij` 是根据空模型下的均值 `μ̂_ij` 计算得出的，反映了不同类别概率的权重。
*   `ỹ`: 这是一个 `n(J-1) x 1` 的向量，是观测到的序数表型的 "one-hot" 编码形式。
*   `μ̂`: 这是一个 `n(J-1) x 1` 的向量，是空模型下对 `ỹ` 的期望值的估计。
*   `W`: 这是一个 `n(J-1) x n(J-1)` 的块对角矩阵，`Ψ`，其对角块 `Ψ_i` 是个体 `i` 的 `(J-1) x (J-1)` 协方差矩阵 `diag(μ̂_i) - μ̂_i μ̂_i^T`。
*   `Y`: 这是一个 `n x 1` 的“工作向量”，`Y = η̂ + (RWR)^-1 R(ỹ - μ̂)`。
*   `P̃`: 这是一个 `n(J-1) x n` 的复杂矩阵，`P̃ = RWRŽ - RWRŽX(...)`。
*   `Ỹ`: 这是一个 `n x 1` 的向量，`Ỹ = Y - Xβ̂`。

**计算效率**: 尽管公式看起来复杂，但 `Ž`, `R`, `W`, `P̃`, `Ỹ` 等所有这些量都**只依赖于空模型的拟合结果**，对于所有待检验的变异都是**固定不变的**。因此，在计算每个变异的得分 `T` 时，主要计算量在于 `G̃` 的计算和最后的向量内积，这使得计算非常高效。

---

### 2. 得分统计量的方差 (Variance of the Score `Var(T)`)

为了标准化得分 `T`，我们需要计算它在空假设下的方差 `Var(T)`。

#### 2.1 理论上的精确方差

根据广义线性混合模型的理论，`T` 的精确方差为：

`Var(T) = G̃^T Ž^T P Σ P^T Ž G̃ = G̃^T Ž^T P̃ΣP̃^T Ž G̃ = G̃^T P̃ŽG̃`

这里的关键符号是：
*   `Σ`: 这是一个 `n(J-1) x n(J-1)` 的矩阵，代表了在空模型下工作向量 `Y` 的协方差矩阵。它的表达式为 `Σ = R^-1 W^-1 R^-1 + τṼ`，其中 `Ṽ = ŽVŽ^T`。`Σ` 包含了由于样本亲缘关系（`τṼ`）和非正态误差（`R^-1 W^-1 R^-1`）引起的复杂方差结构。
*   `P`: 这是 `n(J-1) x n(J-1)` 的投影矩阵 `P = Σ^-1 - Σ^-1 ŽX(X^T Ž^T Σ^-1 ŽX)^-1 X^T Ž^T Σ^-1`。

**计算瓶颈**: 直接计算 `G̃^T P̃ŽG̃` 涉及到 `Σ` 的求逆以及大量矩阵乘法。由于 `Σ` 是一个 `n(J-1) x n(J-1)` 的大型稠密矩阵，这个计算的复杂度极高，对于全基因组分析是不可行的。

#### 2.2 高效的方差估计策略

为了克服计算瓶颈，文章采用了与BOLT-LMM和SAIGE相同的**比率估计近似法**。

**步骤 1: 定义一个易于计算的近似方差 `Var*(T)`**

作者定义了一个近似方差 `Var*(T)`，它忽略了样本亲缘关系对非对角线元素的影响，只保留了主要的对角结构。其表达式为：

`Var*(T) = G̃^T Ž^T RWRŽG̃`

由于 `R` 和 `W` 都是（块）对角矩阵，`Ž^T RWRŽ` 也是一个对角矩阵。因此，`Var*(T)` 的计算非常快，复杂度仅为 `O(n)`。

**步骤 2: 估计校正比率 `r̂`**

模型假设，对于大多数等位基因频率相似的变异，精确方差 `Var(T)` 和近似方差 `Var*(T)` 之间的比率 `r` 是一个近似的常数。

`r = Var(T) / Var*(T)`

为了估计这个比率 `r̂`：
1.  从基因组中随机选取一小组（通常少于30个）变异。
2.  对于这组变异，**不惜计算成本**，使用精确的（但缓慢的）方法计算出它们的 `Var(T)` 和 `Var*(T)`。
3.  计算每个变异的比率 `r_i`。
4.  将这些 `r_i` 平均，得到最终的估计值 `r̂ = mean(Var_i(T) / Var*_i(T))`。文章提到，他们会增加选取的变异数量，直到 `r̂` 的变异系数低于一个预设的阈值（如0.0025），以确保估计的稳定性。

**步骤 3: 计算所有变异的最终方差**

对于基因组中剩下的数百万个变异，只需进行以下快速计算：
1.  计算该变异的近似方差 `Var*(T)` (复杂度 `O(n)`)。
2.  将其乘以之前估计好的校正比率 `r̂`，得到最终的方差估计：
    `Vâr(T) = r̂ * Var*(T)`

---

### 总结

本节详细阐述了POLMM如何实现快速的全基因组关联分析。其精髓在于：

1.  **检验方法**: 采用**得分检验（Score Test）**，其计算仅需空模型的结果，避免了为每个变异重新拟合模型的巨大开销。
2.  **方差估计**: 针对得分检验中方差计算的瓶颈，没有采用直接但不可行的精确计算，而是实现了一个**两阶段的近似策略**：
    *   **阶段一 (校准)**: 用精确方法为一小部分变异计算方差，从而估计出一个全局的**校正比率 `r̂`**。
    *   **阶段二 (应用)**: 对所有变异使用一个计算开销极低的近似方差公式，然后用 `r̂` 对其进行校正。

通过这种方式，POLMM将每个变异的关联检验所需的核心计算（得分和方差）都降低到了 `O(n)` 的复杂度，使其能够高效地处理大规模生物银行级别的数据。