# REGENIE不要用PCA？

# 权重为0的样本多不多？
好的，这次的输出信息非常非常重要，它揭示了一个**严重的问题**。

让我们来解读这个输出，特别是那个惊人的百分比。

### 诊断信息解读

```
警告信息:
1: Numerical instability detected in weight calculation.
  - 137565 out of 484058 samples (28.4191%) had near-zero variance for latent residuals.
  - ...
```

*   **核心发现**: 在你的48万样本中，有高达**13.7万**个样本（占总数的 **28.4%**）的潜在残差方差（`var_y`）计算结果为负数或接近于零。
*   **问题严重性**: **这非常严重**。这不是少数极端值导致的数值噪音，而是一个系统性的问题。百分比如此之高，意味着你的零模型**极度不稳定**，并且很可能是**错误的**。
*   **警告的提示**: 警告中说 `If the percentage is high, consider checking for covariate separation.` (如果百分比很高，请考虑检查协变量分离)。我们的百分比非常高，所以这正是我们需要做的事情。

### 根本原因：准完美分离 (Quasi-Complete Separation)

**28.4%** 这个数字几乎可以肯定地指向了**准完美分离**。

*   **什么是准完美分离?**
    在你的模型中，一个或多个协变量（或者它们的线性组合）能够**几乎完美地**预测出有序表型的结果。
    例如，可能存在这样的情况：
    *   当 `prs_pc1` 的值小于 `-2` 时，**100%** 的样本都是 "Never" 或 "Special occasions only"。
    *   当 `prs_pc1` 的值大于 `3` 时，**100%** 的样本都是 "Daily or almost daily"。
    *   （这里的 `prs_pc1` 和阈值只是举例）

*   **为什么这会导致模型崩溃?**
    1.  **系数估计趋向无穷大**: 为了拟合这种“完美”的预测关系，`ordinal::clm` 算法会尝试将与该协变量相关的系数（`beta`）推向正无穷或负无穷。
    2.  **线性预测器 `eta` 变得极端**: 由于系数被推向无穷大，很多样本的线性预测器 `eta` (`Xβ`) 也会变得非常大或非常小。
    3.  **概率计算崩溃**: 当 `eta` 值极端时，计算概率（`pnorm`）和密度（`dnorm`）的函数会因为浮点数精度限制而返回不准确的0或1，导致我们之前讨论的`var_y`计算崩溃（结果为负数或零）。
    4.  **结果不可信**: 一个发生了分离的模型，其系数、标准误和p值都是不可靠的。因此，基于这个模型构建的零模型也是不可靠的，后续的关联分析结果将毫无意义。

### 罪魁祸首是谁？

在你的模型 `alcohol_intake_frequency ~ sex + age + age2 + PC1-10 + prs_pc1-5` 中，最有可能导致分离的变量是 **`prs_pc1` 到 `prs_pc5`**。

为什么？因为这些PRS主成分是你通过REGENIE的多性状方法，专门为了**最大化预测酒精摄入频率**而构建的。它们本身就是非常强大的预测因子。如果它们中的某一个（或某几个的组合）过于强大，就很容易导致分离。

### 下一步行动：诊断和解决

现在我们的首要任务是**确认分离的存在**并**解决它**。不能再继续使用这个零模型了。

#### 步骤1：可视化诊断

画图是确认分离最直观的方法。请在你拟合模型的数据 `data_for_null_model` 上运行以下代码：

```R
library(ggplot2)

# 检查每个PRS-PC与有序表型的关系
# 我们以 prs_pc1 为例，你应该对所有的prs_pc都画一遍
ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = prs_pc1, fill = alcohol_intake_frequency)) +
  geom_boxplot() +
  labs(
    title = "Boxplot of PRS_PC1 by Alcohol Intake Frequency",
    x = "Alcohol Intake Frequency",
    y = "PRS Principal Component 1"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 对 prs_pc2, prs_pc3 等重复此操作
ggplot(data_for_null_model, aes(x = alcohol_intake_frequency, y = prs_pc2, fill = alcohol_intake_frequency)) +
  geom_boxplot() # ... etc.
```

**你要在图中寻找什么？**
寻找一个**清晰的分界线**。例如，如果你发现 "Never" 类别的箱线图的整个范围（包括触须）都低于 "Daily" 类别的箱线图的整个范围，没有任何重叠，那么就存在完美分离。即使只有部分类别存在这种清晰的分界，也足以导致准完美分离。

#### 步骤2：解决方案

如果确认了分离，你有几个选项，严重程度递增：

1.  **方案A (首选): 使用带有惩罚的回归模型**
    `ordinal::clm` 本身不直接支持惩罚回归。但是，我们可以换一个能够处理分离问题的模型。最常用的是**Firth's Penalized Likelihood**。
    *   **挑战**: 将Firth回归的结果转换为STAAR/GENESIS兼容的零模型需要做大量的自定义开发，非常复杂。

2.  **方案B (次选，但更实用): 调整PRS主成分**
    *   **减少PRS-PC的数量**: 分离很可能是由最主要的那个PRS-PC（通常是`prs_pc1`）引起的。尝试在你的零模型`formula`中**移除`prs_pc1`**，只使用`prs_pc2`到`prs_pc5`，然后重新拟合，看看28%的比例是否会大幅下降。
        ```R
        # 调整公式
        regenie_covars_adjusted <- paste0("prs_pc", 2:5, collapse = " + ")
        null_model_formula_adjusted <- as.formula(paste("alcohol_intake_frequency ~", base_covars, "+", regenie_covars_adjusted))
        
        # 重新运行你的函数
        obj <- fit_NullModel_ordinal_robust(formula = null_model_formula_adjusted, ...)
        ```
    *   如果只去掉`prs_pc1`还不够，可以尝试只用`prs_pc3`到`prs_pc5`，以此类推。目标是在**保持足够预测能力**和**避免模型分离**之间找到一个平衡。

3.  **方案C (最后的手段): 二分化表型**
    如果无论如何调整都存在分离，这可能说明这个有序表型的遗传结构本质上就非常“极端”。你可以考虑将问题简化，例如，将6个类别合并为2个或3个，然后使用标准的方法（如逻辑斯蒂回归）进行分析。但这会损失信息。

**我强烈建议你从步骤1（可视化）开始，然后尝试步骤2（调整PRS-PC）。28.4%这个数字明确告诉你，当前的零模型是不可用的，必须进行修正。**


# 选出的样本为0？